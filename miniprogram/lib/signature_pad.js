"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var bezier_1 = require("./bezier");
var point_1 = require("./point");
var throttle_1 = require("./throttle");
var SignaturePad = (function () {
    function SignaturePad(canvas, options) {
        if (options === void 0) { options = {}; }
        var _this = this;
        this.canvas = canvas;
        this.options = options;
        this._mouseButtonDown = false;
        this._isEmpty = false;
        this._lastPoints = [];
        this._data = [];
        this._lastVelocity = 1;
        this._lastWidth = 1;
        this.handleTouchStart = function (event) {
            _this._handleTouchStart(event);
        };
        this.handleTouchMove = function (event) {
            _this._handleTouchMove(event);
        };
        this.handleTouchEnd = function (event) {
            _this._handleTouchEnd(event);
        };
        this._handleTouchStart = function (event) {
            if (event.touches.length === 1) {
                var touch = event.changedTouches[0];
                _this._strokeBegin(touch);
            }
        };
        this._handleTouchMove = function (event) {
            var touch = event.touches[0];
            _this._strokeMoveUpdate(touch);
        };
        this._handleTouchEnd = function (event) {
            var wasCanvasTouched = event.target === _this.canvas;
            if (wasCanvasTouched) {
                var touch = event.changedTouches[0];
                _this._strokeEnd(touch);
            }
        };
        this.velocityFilterWeight = options.velocityFilterWeight || 0.7;
        this.minWidth = options.minWidth || 0.5;
        this.maxWidth = options.maxWidth || 2.5;
        this.throttle = ('throttle' in options ? options.throttle : 16);
        this.minDistance = ('minDistance' in options
            ? options.minDistance
            : 5);
        this.dotSize =
            options.dotSize ||
                function dotSize() {
                    return (this.minWidth + this.maxWidth) / 2;
                };
        this.penColor = options.penColor || 'black';
        this.backgroundColor = options.backgroundColor || 'rgba(0,0,0,0)';
        this._strokeMoveUpdate = this.throttle
            ? throttle_1.throttle(SignaturePad.prototype._strokeUpdate, this.throttle)
            : SignaturePad.prototype._strokeUpdate;
        this._ctx = canvas.getContext('2d');
        this.clear();
    }
    SignaturePad.prototype.clear = function () {
        var _a = this, ctx = _a._ctx, canvas = _a.canvas;
        ctx.fillStyle = this.backgroundColor;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        this._data = [];
        this._reset();
        this._isEmpty = true;
    };
    SignaturePad.prototype.fromDataURL = function (dataUrl, options, callback) {
        if (options === void 0) { options = {}; }
        var ratio = options.ratio;
        var width = options.width;
        var height = options.height;
        this._reset();
        this._isEmpty = false;
    };
    SignaturePad.prototype.isEmpty = function () {
        return this._isEmpty;
    };
    SignaturePad.prototype.fromData = function (pointGroups) {
        var _this = this;
        this.clear();
        this._fromData(pointGroups, function (_a) {
            var color = _a.color, curve = _a.curve;
            return _this._drawCurve({ color: color, curve: curve });
        }, function (_a) {
            var color = _a.color, point = _a.point;
            return _this._drawDot({ color: color, point: point });
        });
        this._data = pointGroups;
    };
    SignaturePad.prototype.toData = function () {
        return this._data;
    };
    SignaturePad.prototype._strokeBegin = function (event) {
        var newPointGroup = {
            color: this.penColor,
            points: [],
        };
        this._data.push(newPointGroup);
        this._reset();
        this._strokeUpdate(event);
    };
    SignaturePad.prototype._strokeUpdate = function (event) {
        if (this._data.length === 0) {
            this._strokeBegin(event);
            return;
        }
        var x = event.clientX;
        var y = event.clientY;
        var point = this._createPoint(x, y);
        var lastPointGroup = this._data[this._data.length - 1];
        var lastPoints = lastPointGroup.points;
        var lastPoint = lastPoints.length > 0 && lastPoints[lastPoints.length - 1];
        var isLastPointTooClose = lastPoint
            ? point.distanceTo(lastPoint) <= this.minDistance
            : false;
        var color = lastPointGroup.color;
        if (!lastPoint || !(lastPoint && isLastPointTooClose)) {
            var curve = this._addPoint(point);
            if (!lastPoint) {
                this._drawDot({ color: color, point: point });
            }
            else if (curve) {
                this._drawCurve({ color: color, curve: curve });
            }
            lastPoints.push({
                time: point.time,
                x: point.x,
                y: point.y,
            });
        }
    };
    SignaturePad.prototype._strokeEnd = function (event) {
        this._strokeUpdate(event);
    };
    SignaturePad.prototype._reset = function () {
        this._lastPoints = [];
        this._lastVelocity = 0;
        this._lastWidth = (this.minWidth + this.maxWidth) / 2;
        this._ctx.fillStyle = this.penColor;
    };
    SignaturePad.prototype._createPoint = function (x, y) {
        var left = 0;
        var top = 0;
        return new point_1.Point(x - left, y - top, new Date().getTime());
    };
    SignaturePad.prototype._addPoint = function (point) {
        var _lastPoints = this._lastPoints;
        _lastPoints.push(point);
        if (_lastPoints.length > 2) {
            if (_lastPoints.length === 3) {
                _lastPoints.unshift(_lastPoints[0]);
            }
            var widths = this._calculateCurveWidths(_lastPoints[1], _lastPoints[2]);
            var curve = bezier_1.Bezier.fromPoints(_lastPoints, widths);
            _lastPoints.shift();
            return curve;
        }
        return null;
    };
    SignaturePad.prototype._calculateCurveWidths = function (startPoint, endPoint) {
        var velocity = this.velocityFilterWeight * endPoint.velocityFrom(startPoint) +
            (1 - this.velocityFilterWeight) * this._lastVelocity;
        var newWidth = this._strokeWidth(velocity);
        var widths = {
            end: newWidth,
            start: this._lastWidth,
        };
        this._lastVelocity = velocity;
        this._lastWidth = newWidth;
        return widths;
    };
    SignaturePad.prototype._strokeWidth = function (velocity) {
        return Math.max(this.maxWidth / (velocity + 1), this.minWidth);
    };
    SignaturePad.prototype._drawCurveSegment = function (x, y, width) {
        var ctx = this._ctx;
        ctx.moveTo(x, y);
        ctx.arc(x, y, width, 0, 2 * Math.PI, false);
        this._isEmpty = false;
    };
    SignaturePad.prototype._drawCurve = function (_a) {
        var color = _a.color, curve = _a.curve;
        var ctx = this._ctx;
        var widthDelta = curve.endWidth - curve.startWidth;
        var drawSteps = Math.floor(curve.length()) * 2;
        ctx.beginPath();
        ctx.fillStyle = color;
        for (var i = 0; i < drawSteps; i += 1) {
            var t = i / drawSteps;
            var tt = t * t;
            var ttt = tt * t;
            var u = 1 - t;
            var uu = u * u;
            var uuu = uu * u;
            var x = uuu * curve.startPoint.x;
            x += 3 * uu * t * curve.control1.x;
            x += 3 * u * tt * curve.control2.x;
            x += ttt * curve.endPoint.x;
            var y = uuu * curve.startPoint.y;
            y += 3 * uu * t * curve.control1.y;
            y += 3 * u * tt * curve.control2.y;
            y += ttt * curve.endPoint.y;
            var width = Math.min(curve.startWidth + ttt * widthDelta, this.maxWidth);
            this._drawCurveSegment(x, y, width);
        }
        ctx.closePath();
        ctx.fill();
    };
    SignaturePad.prototype._drawDot = function (_a) {
        var color = _a.color, point = _a.point;
        var ctx = this._ctx;
        var width = typeof this.dotSize === 'function' ? this.dotSize() : this.dotSize;
        ctx.beginPath();
        this._drawCurveSegment(point.x, point.y, width);
        ctx.closePath();
        ctx.fillStyle = color;
        ctx.fill();
    };
    SignaturePad.prototype._fromData = function (pointGroups, drawCurve, drawDot) {
        for (var _i = 0, pointGroups_1 = pointGroups; _i < pointGroups_1.length; _i++) {
            var group = pointGroups_1[_i];
            var color = group.color, points = group.points;
            if (points.length > 1) {
                for (var j = 0; j < points.length; j += 1) {
                    var basicPoint = points[j];
                    var point = new point_1.Point(basicPoint.x, basicPoint.y, basicPoint.time);
                    this.penColor = color;
                    if (j === 0) {
                        this._reset();
                    }
                    var curve = this._addPoint(point);
                    if (curve) {
                        drawCurve({ color: color, curve: curve });
                    }
                }
            }
            else {
                this._reset();
                drawDot({
                    color: color,
                    point: points[0],
                });
            }
        }
    };
    return SignaturePad;
}());
exports.default = SignaturePad;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2lnbmF0dXJlX3BhZC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInNpZ25hdHVyZV9wYWQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFXQSxtQ0FBa0M7QUFDbEMsaUNBQTRDO0FBQzVDLHVDQUFzQztBQWtCdEM7SUF1QkUsc0JBQ1UsTUFBVyxFQUNYLE9BQXFCO1FBQXJCLHdCQUFBLEVBQUEsWUFBcUI7UUFGL0IsaUJBMkJDO1FBMUJTLFdBQU0sR0FBTixNQUFNLENBQUs7UUFDWCxZQUFPLEdBQVAsT0FBTyxDQUFjO1FBWHZCLHFCQUFnQixHQUFZLEtBQUssQ0FBQztRQUNsQyxhQUFRLEdBQVksS0FBSyxDQUFDO1FBQzFCLGdCQUFXLEdBQVksRUFBRSxDQUFDO1FBQzFCLFVBQUssR0FBaUIsRUFBRSxDQUFDO1FBQ3pCLGtCQUFhLEdBQVcsQ0FBQyxDQUFDO1FBQzFCLGVBQVUsR0FBVyxDQUFDLENBQUM7UUFnRnhCLHFCQUFnQixHQUFHLFVBQUMsS0FBVTtZQUNuQyxLQUFJLENBQUMsaUJBQWlCLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDaEMsQ0FBQyxDQUFBO1FBRU0sb0JBQWUsR0FBRyxVQUFDLEtBQVU7WUFDbEMsS0FBSSxDQUFDLGdCQUFnQixDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQy9CLENBQUMsQ0FBQTtRQUVNLG1CQUFjLEdBQUcsVUFBQyxLQUFVO1lBQ2pDLEtBQUksQ0FBQyxlQUFlLENBQUMsS0FBSyxDQUFDLENBQUE7UUFDN0IsQ0FBQyxDQUFBO1FBRU8sc0JBQWlCLEdBQUcsVUFBQyxLQUFVO1lBSXJDLElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO2dCQUM5QixJQUFNLEtBQUssR0FBRyxLQUFLLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUN0QyxLQUFJLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBQyxDQUFDO2FBQzFCO1FBQ0gsQ0FBQyxDQUFDO1FBRU0scUJBQWdCLEdB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QUFDO3FCQUNmO29CQUVELElBQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUM7b0JBRXBDLElBQUksS0FBSyxFQUFFO3dCQUNULFNBQVMsQ0FBQyxFQUFFLEtBQUssT0FBQSxFQUFFLEtBQUssT0FBQSxFQUFFLENBQUMsQ0FBQztxQkFDN0I7aUJBQ0Y7YUFDRjtpQkFBTTtnQkFDTCxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7Z0JBRWQsT0FBTyxDQUFDO29CQUNOLEtBQUssT0FBQTtvQkFDTCxLQUFLLEVBQUUsTUFBTSxDQUFDLENBQUMsQ0FBQztpQkFDakIsQ0FBQyxDQUFDO2FBQ0o7U0FDRjtJQUNILENBQUM7SUFDSCxtQkFBQztBQUFELENBQUMsQUE1V0QsSUE0V0MiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIFRoZSBtYWluIGlkZWEgYW5kIHNvbWUgcGFydHMgb2YgdGhlIGNvZGUgKGUuZy4gZHJhd2luZyB2YXJpYWJsZSB3aWR0aCBCw6l6aWVyIGN1cnZlKSBhcmUgdGFrZW4gZnJvbTpcbiAqIGh0dHA6Ly9jb3JuZXIuc3F1YXJldXAuY29tLzIwMTIvMDcvc21vb3RoZXItc2lnbmF0dXJlcy5odG1sXG4gKlxuICogSW1wbGVtZW50YXRpb24gb2YgaW50ZXJwb2xhdGlvbiB1c2luZyBjdWJpYyBCw6l6aWVyIGN1cnZlcyBpcyB0YWtlbiBmcm9tOlxuICogaHR0cDovL3d3dy5iZW5rbm93c2NvZGUuY29tLzIwMTIvMDkvcGF0aC1pbnRlcnBvbGF0aW9uLXVzaW5nLWN1YmljLWJlemllcl85NzQyLmh0bWxcbiAqXG4gKiBBbGdvcml0aG0gZm9yIGFwcHJveGltYXRlZCBsZW5ndGggb2YgYSBCw6l6aWVyIGN1cnZlIGlzIHRha2VuIGZyb206XG4gKiBodHRwOi8vd3d3LmxlbW9kYS5uZXQvbWF0aHMvYmV6aWVyLWxlbmd0aC9pbmRleC5odG1sXG4gKi9cblxuaW1wb3J0IHsgQmV6aWVyIH0gZnJvbSAnLi9iZXppZXInO1xuaW1wb3J0IHsgQmFzaWNQb2ludCwgUG9pbnQgfSBmcm9tICcuL3BvaW50JztcbmltcG9ydCB7IHRocm90dGxlIH0gZnJvbSAnLi90aHJvdHRsZSc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgT3B0aW9ucyB7XG4gIGRvdFNpemU/OiBudW1iZXIgfCAoKCkgPT4gbnVtYmVyKTtcbiAgbWluV2lkdGg/OiBudW1iZXI7XG4gIG1heFdpZHRoPzogbnVtYmVyO1xuICBtaW5EaXN0YW5jZT86IG51bWJlcjtcbiAgYmFja2dyb3VuZENvbG9yPzogc3RyaW5nO1xuICBwZW5Db2xvcj86IHN0cmluZztcbiAgdGhyb3R0bGU/OiBudW1iZXI7XG4gIHZlbG9jaXR5RmlsdGVyV2VpZ2h0PzogbnVtYmVyO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFBvaW50R3JvdXAge1xuICBjb2xvcjogc3RyaW5nO1xuICBwb2ludHM6IEJhc2ljUG9pbnRbXTtcbn1cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgU2lnbmF0dXJlUGFkIHtcbiAgLy8gUHVibGljIHN0dWZmXG4gIHB1YmxpYyBkb3RTaXplOiBudW1iZXIgfCAoKCkgPT4gbnVtYmVyKTtcbiAgcHVibGljIG1pbldpZHRoOiBudW1iZXI7XG4gIHB1YmxpYyBtYXhXaWR0aDogbnVtYmVyO1xuICBwdWJsaWMgbWluRGlzdGFuY2U6IG51bWJlcjtcbiAgcHVibGljIGJhY2tncm91bmRDb2xvcjogc3RyaW5nO1xuICBwdWJsaWMgcGVuQ29sb3I6IHN0cmluZztcbiAgcHVibGljIHRocm90dGxlOiBudW1iZXI7XG4gIHB1YmxpYyB2ZWxvY2l0eUZpbHRlcldlaWdodDogbnVtYmVyO1xuXG4gIC8vIFByaXZhdGUgc3R1ZmZcbiAgLyogdHNsaW50OmRpc2FibGU6IHZhcmlhYmxlLW5hbWUgKi9cbiAgcHJpdmF0ZSBfY3R4OiBhbnk7XG4gIHByaXZhdGUgX21vdXNlQnV0dG9uRG93bjogYm9vbGVhbiA9IGZhbHNlO1xuICBwcml2YXRlIF9pc0VtcHR5OiBib29sZWFuID0gZmFsc2U7XG4gIHByaXZhdGUgX2xhc3RQb2ludHM6IFBvaW50W10gPSBbXTsgLy8gU3RvcmVzIHVwIHRvIDQgbW9zdCByZWNlbnQgcG9pbnRzOyB1c2VkIHRvIGdlbmVyYXRlIGEgbmV3IGN1cnZlXG4gIHByaXZhdGUgX2RhdGE6IFBvaW50R3JvdXBbXSA9IFtdOyAvLyBTdG9yZXMgYWxsIHBvaW50cyBpbiBncm91cHMgKG9uZSBncm91cCBwZXIgbGluZSBvciBkb3QpXG4gIHByaXZhdGUgX2xhc3RWZWxvY2l0eTogbnVtYmVyID0gMTtcbiAgcHJpdmF0ZSBfbGFzdFdpZHRoOiBudW1iZXIgPSAxO1xuICBwcml2YXRlIF9zdHJva2VNb3ZlVXBkYXRlOiAoZXZlbnQ6IGFueSkgPT4gdm9pZDtcbiAgLyogdHNsaW50OmVuYWJsZTogdmFyaWFibGUtbmFtZSAqL1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgY2FudmFzOiBhbnksXG4gICAgcHJpdmF0ZSBvcHRpb25zOiBPcHRpb25zID0ge30sXG4gICkge1xuICAgIHRoaXMudmVsb2NpdHlGaWx0ZXJXZWlnaHQgPSBvcHRpb25zLnZlbG9jaXR5RmlsdGVyV2VpZ2h0IHx8IDAuNztcbiAgICB0aGlzLm1pbldpZHRoID0gb3B0aW9ucy5taW5XaWR0aCB8fCAwLjU7XG4gICAgdGhpcy5tYXhXaWR0aCA9IG9wdGlvbnMubWF4V2lkdGggfHwgMi41O1xuICAgIHRoaXMudGhyb3R0bGUgPSAoJ3Rocm90dGxlJyBpbiBvcHRpb25zID8gb3B0aW9ucy50aHJvdHRsZSA6IDE2KSBhcyBudW1iZXI7IC8vIGluIG1pbGlzZWNvbmRzc1xuICAgIHRoaXMubWluRGlzdGFuY2UgPSAoJ21pbkRpc3RhbmNlJyBpbiBvcHRpb25zXG4gICAgICA/IG9wdGlvbnMubWluRGlzdGFuY2VcbiAgICAgIDogNSkgYXMgbnVtYmVyOyAvLyBpbiBwaXhlbHNcbiAgICB0aGlzLmRvdFNpemUgPVxuICAgICAgb3B0aW9ucy5kb3RTaXplIHx8XG4gICAgICBmdW5jdGlvbiBkb3RTaXplKHRoaXM6IFNpZ25hdHVyZVBhZCk6IG51bWJlciB7XG4gICAgICAgIHJldHVybiAodGhpcy5taW5XaWR0aCArIHRoaXMubWF4V2lkdGgpIC8gMjtcbiAgICAgIH07XG4gICAgdGhpcy5wZW5Db2xvciA9IG9wdGlvbnMucGVuQ29sb3IgfHwgJ2JsYWNrJztcbiAgICB0aGlzLmJhY2tncm91bmRDb2xvciA9IG9wdGlvbnMuYmFja2dyb3VuZENvbG9yIHx8ICdyZ2JhKDAsMCwwLDApJztcblxuICAgIHRoaXMuX3N0cm9rZU1vdmVVcGRhdGUgPSB0aGlzLnRocm90dGxlXG4gICAgICA/IHRocm90dGxlKFNpZ25hdHVyZVBhZC5wcm90b3R5cGUuX3N0cm9rZVVwZGF0ZSwgdGhpcy50aHJvdHRsZSlcbiAgICAgIDogU2lnbmF0dXJlUGFkLnByb3RvdHlwZS5fc3Ryb2tlVXBkYXRlO1xuICAgIHRoaXMuX2N0eCA9IGNhbnZhcy5nZXRDb250ZXh0KCcyZCcpO1xuXG4gICAgdGhpcy5jbGVhcigpO1xuXG4gICAgLy8gRW5hYmxlIG1vdXNlIGFuZCB0b3VjaCBldmVudCBoYW5kbGVyc1xuICB9XG5cbiAgcHVibGljIGNsZWFyKCk6IHZvaWQge1xuICAgIGNvbnN0IHsgX2N0eDogY3R4LCBjYW52YXMgfSA9IHRoaXM7XG5cbiAgICAvLyBDbGVhciBjYW52YXMgdXNpbmcgYmFja2dyb3VuZCBjb2xvclxuICAgIGN0eC5maWxsU3R5bGUgPSB0aGlzLmJhY2tncm91bmRDb2xvcjtcbiAgICBjdHguY2xlYXJSZWN0KDAsIDAsIGNhbnZhcy53aWR0aCwgY2FudmFzLmhlaWdodCk7XG4gICAgY3R4LmZpbGxSZWN0KDAsIDAsIGNhbnZhcy53aWR0aCwgY2FudmFzLmhlaWdodCk7XG5cbiAgICB0aGlzLl9kYXRhID0gW107XG4gICAgdGhpcy5fcmVzZXQoKTtcbiAgICB0aGlzLl9pc0VtcHR5ID0gdHJ1ZTtcbiAgfVxuXG4gIHB1YmxpYyBmcm9tRGF0YVVSTChcbiAgICBkYXRhVXJsOiBzdHJpbmcsXG4gICAgb3B0aW9uczogeyByYXRpbz86IG51bWJlcjsgd2lkdGg/OiBudW1iZXI7IGhlaWdodD86IG51bWJlciB9ID0ge30sXG4gICAgY2FsbGJhY2s/OiAoZXJyb3I/OiBzdHJpbmcpID0+IHZvaWQsXG4gICk6IHZvaWQge1xuICAgIC8vIGNvbnN0IGltYWdlID0gbmV3IEltYWdlKCk7XG4gICAgY29uc3QgcmF0aW8gPSBvcHRpb25zLnJhdGlvO1xuICAgIGNvbnN0IHdpZHRoID0gb3B0aW9ucy53aWR0aDtcbiAgICBjb25zdCBoZWlnaHQgPSBvcHRpb25zLmhlaWdodDtcblxuICAgIHRoaXMuX3Jlc2V0KCk7XG4gICAgdGhpcy5faXNFbXB0eSA9IGZhbHNlO1xuICB9XG5cbiAgcHVibGljIGlzRW1wdHkoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuX2lzRW1wdHk7XG4gIH1cblxuICBwdWJsaWMgZnJvbURhdGEocG9pbnRHcm91cHM6IFBvaW50R3JvdXBbXSk6IHZvaWQge1xuICAgIHRoaXMuY2xlYXIoKTtcblxuICAgIHRoaXMuX2Zyb21EYXRhKFxuICAgICAgcG9pbnRHcm91cHMsXG4gICAgICAoeyBjb2xvciwgY3VydmUgfSkgPT4gdGhpcy5fZHJhd0N1cnZlKHsgY29sb3IsIGN1cnZlIH0pLFxuICAgICAgKHsgY29sb3IsIHBvaW50IH0pID0+IHRoaXMuX2RyYXdEb3QoeyBjb2xvciwgcG9pbnQgfSksXG4gICAgKTtcblxuICAgIHRoaXMuX2RhdGEgPSBwb2ludEdyb3VwcztcbiAgfVxuXG4gIHB1YmxpYyB0b0RhdGEoKTogUG9pbnRHcm91cFtdIHtcbiAgICByZXR1cm4gdGhpcy5fZGF0YTtcbiAgfVxuXG4gIHB1YmxpYyBoYW5kbGVUb3VjaFN0YXJ0ID0gKGV2ZW50OiBhbnkpOiB2b2lkID0+IHtcbiAgICB0aGlzLl9oYW5kbGVUb3VjaFN0YXJ0KGV2ZW50KTtcbiAgfVxuXG4gIHB1YmxpYyBoYW5kbGVUb3VjaE1vdmUgPSAoZXZlbnQ6IGFueSk6IHZvaWQgPT4ge1xuICAgIHRoaXMuX2hhbmRsZVRvdWNoTW92ZShldmVudCk7XG4gIH1cblxuICBwdWJsaWMgaGFuZGxlVG91Y2hFbmQgPSAoZXZlbnQ6IGFueSk6IHZvaWQgPT4ge1xuICAgIHRoaXMuX2hhbmRsZVRvdWNoRW5kKGV2ZW50KVxuICB9XG5cbiAgcHJpdmF0ZSBfaGFuZGxlVG91Y2hTdGFydCA9IChldmVudDogYW55KTogdm9pZCA9PiB7XG4gICAgLy8gUHJldmVudCBzY3JvbGxpbmcuXG4gICAgLy8gZXZlbnQucHJldmVudERlZmF1bHQoKTtcblxuICAgIGlmIChldmVudC50b3VjaGVzLmxlbmd0aCA9PT0gMSkge1xuICAgICAgY29uc3QgdG91Y2ggPSBldmVudC5jaGFuZ2VkVG91Y2hlc1swXTtcbiAgICAgIHRoaXMuX3N0cm9rZUJlZ2luKHRvdWNoKTtcbiAgICB9XG4gIH07XG5cbiAgcHJpdmF0ZSBfaGFuZGxlVG91Y2hNb3ZlID0gKGV2ZW50OiBhbnkpOiB2b2lkID0+IHtcbiAgICAvLyBQcmV2ZW50IHNjcm9sbGluZy5cbiAgICAvLyBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuXG4gICAgY29uc3QgdG91Y2ggPSBldmVudC50b3VjaGVzWzBdO1xuICAgIHRoaXMuX3N0cm9rZU1vdmVVcGRhdGUodG91Y2gpO1xuICB9O1xuXG4gIHByaXZhdGUgX2hhbmRsZVRvdWNoRW5kID0gKGV2ZW50OiBhbnkpOiB2b2lkID0+IHtcbiAgICBjb25zdCB3YXNDYW52YXNUb3VjaGVkID0gZXZlbnQudGFyZ2V0ID09PSB0aGlzLmNhbnZhcztcbiAgICBpZiAod2FzQ2FudmFzVG91Y2hlZCkge1xuICAgICAgLy8gZXZlbnQucHJldmVudERlZmF1bHQoKTtcblxuICAgICAgY29uc3QgdG91Y2ggPSBldmVudC5jaGFuZ2VkVG91Y2hlc1swXTtcbiAgICAgIHRoaXMuX3N0cm9rZUVuZCh0b3VjaCk7XG4gICAgfVxuICB9O1xuXG4gIC8vIFByaXZhdGUgbWV0aG9kc1xuICBwcml2YXRlIF9zdHJva2VCZWdpbihldmVudDogYW55KTogdm9pZCB7XG4gICAgY29uc3QgbmV3UG9pbnRHcm91cCA9IHtcbiAgICAgIGNvbG9yOiB0aGlzLnBlbkNvbG9yLFxuICAgICAgcG9pbnRzOiBbXSxcbiAgICB9O1xuXG4gICAgdGhpcy5fZGF0YS5wdXNoKG5ld1BvaW50R3JvdXApO1xuICAgIHRoaXMuX3Jlc2V0KCk7XG4gICAgdGhpcy5fc3Ryb2tlVXBkYXRlKGV2ZW50KTtcbiAgfVxuXG4gIHByaXZhdGUgX3N0cm9rZVVwZGF0ZShldmVudDogYW55KTogdm9pZCB7XG4gICAgaWYgKHRoaXMuX2RhdGEubGVuZ3RoID09PSAwKSB7XG4gICAgICAvLyBUaGlzIGNhbiBoYXBwZW4gaWYgY2xlYXIoKSB3YXMgY2FsbGVkIHdoaWxlIGEgc2lnbmF0dXJlIGlzIHN0aWxsIGluIHByb2dyZXNzLFxuICAgICAgLy8gb3IgaWYgdGhlcmUgaXMgYSByYWNlIGNvbmRpdGlvbiBiZXR3ZWVuIHN0YXJ0L3VwZGF0ZSBldmVudHMuXG4gICAgICB0aGlzLl9zdHJva2VCZWdpbihldmVudCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgeCA9IGV2ZW50LmNsaWVudFg7XG4gICAgY29uc3QgeSA9IGV2ZW50LmNsaWVudFk7XG5cbiAgICBjb25zdCBwb2ludCA9IHRoaXMuX2NyZWF0ZVBvaW50KHgsIHkpO1xuICAgIGNvbnN0IGxhc3RQb2ludEdyb3VwID0gdGhpcy5fZGF0YVt0aGlzLl9kYXRhLmxlbmd0aCAtIDFdO1xuICAgIGNvbnN0IGxhc3RQb2ludHMgPSBsYXN0UG9pbnRHcm91cC5wb2ludHM7XG4gICAgY29uc3QgbGFzdFBvaW50ID1cbiAgICAgIGxhc3RQb2ludHMubGVuZ3RoID4gMCAmJiBsYXN0UG9pbnRzW2xhc3RQb2ludHMubGVuZ3RoIC0gMV07XG4gICAgY29uc3QgaXNMYXN0UG9pbnRUb29DbG9zZSA9IGxhc3RQb2ludFxuICAgICAgPyBwb2ludC5kaXN0YW5jZVRvKGxhc3RQb2ludCkgPD0gdGhpcy5taW5EaXN0YW5jZVxuICAgICAgOiBmYWxzZTtcbiAgICBjb25zdCBjb2xvciA9IGxhc3RQb2ludEdyb3VwLmNvbG9yO1xuXG4gICAgLy8gU2tpcCB0aGlzIHBvaW50IGlmIGl0J3MgdG9vIGNsb3NlIHRvIHRoZSBwcmV2aW91cyBvbmVcbiAgICBpZiAoIWxhc3RQb2ludCB8fCAhKGxhc3RQb2ludCAmJiBpc0xhc3RQb2ludFRvb0Nsb3NlKSkge1xuICAgICAgY29uc3QgY3VydmUgPSB0aGlzLl9hZGRQb2ludChwb2ludCk7XG5cbiAgICAgIGlmICghbGFzdFBvaW50KSB7XG4gICAgICAgIHRoaXMuX2RyYXdEb3QoeyBjb2xvciwgcG9pbnQgfSk7XG4gICAgICB9IGVsc2UgaWYgKGN1cnZlKSB7XG4gICAgICAgIHRoaXMuX2RyYXdDdXJ2ZSh7IGNvbG9yLCBjdXJ2ZSB9KTtcbiAgICAgIH1cblxuICAgICAgbGFzdFBvaW50cy5wdXNoKHtcbiAgICAgICAgdGltZTogcG9pbnQudGltZSxcbiAgICAgICAgeDogcG9pbnQueCxcbiAgICAgICAgeTogcG9pbnQueSxcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgX3N0cm9rZUVuZChldmVudDogYW55KTogdm9pZCB7XG4gICAgdGhpcy5fc3Ryb2tlVXBkYXRlKGV2ZW50KTtcbiAgfVxuXG4gIC8vIENhbGxlZCB3aGVuIGEgbmV3IGxpbmUgaXMgc3RhcnRlZFxuICBwcml2YXRlIF9yZXNldCgpOiB2b2lkIHtcbiAgICB0aGlzLl9sYXN0UG9pbnRzID0gW107XG4gICAgdGhpcy5fbGFzdFZlbG9jaXR5ID0gMDtcbiAgICB0aGlzLl9sYXN0V2lkdGggPSAodGhpcy5taW5XaWR0aCArIHRoaXMubWF4V2lkdGgpIC8gMjtcbiAgICB0aGlzLl9jdHguZmlsbFN0eWxlID0gdGhpcy5wZW5Db2xvcjtcbiAgfVxuXG4gIHByaXZhdGUgX2NyZWF0ZVBvaW50KHg6IG51bWJlciwgeTogbnVtYmVyKTogUG9pbnQge1xuICAgIC8vIGNvbnN0IHJlY3QgPSB0aGlzLmNhbnZhcy5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcbiAgICBjb25zdCBsZWZ0ID0gMFxuICAgIGNvbnN0IHRvcCA9IDBcblxuICAgIHJldHVybiBuZXcgUG9pbnQoeCAtIGxlZnQsIHkgLSB0b3AsIG5ldyBEYXRlKCkuZ2V0VGltZSgpKTtcbiAgfVxuXG4gIC8vIEFkZCBwb2ludCB0byBfbGFzdFBvaW50cyBhcnJheSBhbmQgZ2VuZXJhdGUgYSBuZXcgY3VydmUgaWYgdGhlcmUgYXJlIGVub3VnaCBwb2ludHMgKGkuZS4gMylcbiAgcHJpdmF0ZSBfYWRkUG9pbnQocG9pbnQ6IFBvaW50KTogQmV6aWVyIHwgbnVsbCB7XG4gICAgY29uc3QgeyBfbGFzdFBvaW50cyB9ID0gdGhpcztcblxuICAgIF9sYXN0UG9pbnRzLnB1c2gocG9pbnQpO1xuXG4gICAgaWYgKF9sYXN0UG9pbnRzLmxlbmd0aCA+IDIpIHtcbiAgICAgIC8vIFRvIHJlZHVjZSB0aGUgaW5pdGlhbCBsYWcgbWFrZSBpdCB3b3JrIHdpdGggMyBwb2ludHNcbiAgICAgIC8vIGJ5IGNvcHlpbmcgdGhlIGZpcnN0IHBvaW50IHRvIHRoZSBiZWdpbm5pbmcuXG4gICAgICBpZiAoX2xhc3RQb2ludHMubGVuZ3RoID09PSAzKSB7XG4gICAgICAgIF9sYXN0UG9pbnRzLnVuc2hpZnQoX2xhc3RQb2ludHNbMF0pO1xuICAgICAgfVxuXG4gICAgICAvLyBfcG9pbnRzIGFycmF5IHdpbGwgYWx3YXlzIGhhdmUgNCBwb2ludHMgaGVyZS5cbiAgICAgIGNvbnN0IHdpZHRocyA9IHRoaXMuX2NhbGN1bGF0ZUN1cnZlV2lkdGhzKF9sYXN0UG9pbnRzWzFdLCBfbGFzdFBvaW50c1syXSk7XG4gICAgICBjb25zdCBjdXJ2ZSA9IEJlemllci5mcm9tUG9pbnRzKF9sYXN0UG9pbnRzLCB3aWR0aHMpO1xuXG4gICAgICAvLyBSZW1vdmUgdGhlIGZpcnN0IGVsZW1lbnQgZnJvbSB0aGUgbGlzdCwgc28gdGhhdCB0aGVyZSBhcmUgbm8gbW9yZSB0aGFuIDQgcG9pbnRzIGF0IGFueSB0aW1lLlxuICAgICAgX2xhc3RQb2ludHMuc2hpZnQoKTtcblxuICAgICAgcmV0dXJuIGN1cnZlO1xuICAgIH1cblxuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgcHJpdmF0ZSBfY2FsY3VsYXRlQ3VydmVXaWR0aHMoXG4gICAgc3RhcnRQb2ludDogUG9pbnQsXG4gICAgZW5kUG9pbnQ6IFBvaW50LFxuICApOiB7IHN0YXJ0OiBudW1iZXI7IGVuZDogbnVtYmVyIH0ge1xuICAgIGNvbnN0IHZlbG9jaXR5ID1cbiAgICAgIHRoaXMudmVsb2NpdHlGaWx0ZXJXZWlnaHQgKiBlbmRQb2ludC52ZWxvY2l0eUZyb20oc3RhcnRQb2ludCkgK1xuICAgICAgKDEgLSB0aGlzLnZlbG9jaXR5RmlsdGVyV2VpZ2h0KSAqIHRoaXMuX2xhc3RWZWxvY2l0eTtcblxuICAgIGNvbnN0IG5ld1dpZHRoID0gdGhpcy5fc3Ryb2tlV2lkdGgodmVsb2NpdHkpO1xuXG4gICAgY29uc3Qgd2lkdGhzID0ge1xuICAgICAgZW5kOiBuZXdXaWR0aCxcbiAgICAgIHN0YXJ0OiB0aGlzLl9sYXN0V2lkdGgsXG4gICAgfTtcblxuICAgIHRoaXMuX2xhc3RWZWxvY2l0eSA9IHZlbG9jaXR5O1xuICAgIHRoaXMuX2xhc3RXaWR0aCA9IG5ld1dpZHRoO1xuXG4gICAgcmV0dXJuIHdpZHRocztcbiAgfVxuXG4gIHByaXZhdGUgX3N0cm9rZVdpZHRoKHZlbG9jaXR5OiBudW1iZXIpOiBudW1iZXIge1xuICAgIHJldHVybiBNYXRoLm1heCh0aGlzLm1heFdpZHRoIC8gKHZlbG9jaXR5ICsgMSksIHRoaXMubWluV2lkdGgpO1xuICB9XG5cbiAgcHJpdmF0ZSBfZHJhd0N1cnZlU2VnbWVudCh4OiBudW1iZXIsIHk6IG51bWJlciwgd2lkdGg6IG51bWJlcik6IHZvaWQge1xuICAgIGNvbnN0IGN0eCA9IHRoaXMuX2N0eDtcblxuICAgIGN0eC5tb3ZlVG8oeCwgeSk7XG4gICAgY3R4LmFyYyh4LCB5LCB3aWR0aCwgMCwgMiAqIE1hdGguUEksIGZhbHNlKTtcbiAgICB0aGlzLl9pc0VtcHR5ID0gZmFsc2U7XG4gIH1cblxuICBwcml2YXRlIF9kcmF3Q3VydmUoeyBjb2xvciwgY3VydmUgfTogeyBjb2xvcjogc3RyaW5nOyBjdXJ2ZTogQmV6aWVyIH0pOiB2b2lkIHtcbiAgICBjb25zdCBjdHggPSB0aGlzLl9jdHg7XG4gICAgY29uc3Qgd2lkdGhEZWx0YSA9IGN1cnZlLmVuZFdpZHRoIC0gY3VydmUuc3RhcnRXaWR0aDtcbiAgICAvLyAnMicgaXMganVzdCBhbiBhcmJpdHJhcnkgbnVtYmVyIGhlcmUuIElmIG9ubHkgbGVuZ2h0IGlzIHVzZWQsIHRoZW5cbiAgICAvLyB0aGVyZSBhcmUgZ2FwcyBiZXR3ZWVuIGN1cnZlIHNlZ21lbnRzIDovXG4gICAgY29uc3QgZHJhd1N0ZXBzID0gTWF0aC5mbG9vcihjdXJ2ZS5sZW5ndGgoKSkgKiAyO1xuXG4gICAgY3R4LmJlZ2luUGF0aCgpO1xuICAgIGN0eC5maWxsU3R5bGUgPSBjb2xvcjtcblxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZHJhd1N0ZXBzOyBpICs9IDEpIHtcbiAgICAgIC8vIENhbGN1bGF0ZSB0aGUgQmV6aWVyICh4LCB5KSBjb29yZGluYXRlIGZvciB0aGlzIHN0ZXAuXG4gICAgICBjb25zdCB0ID0gaSAvIGRyYXdTdGVwcztcbiAgICAgIGNvbnN0IHR0ID0gdCAqIHQ7XG4gICAgICBjb25zdCB0dHQgPSB0dCAqIHQ7XG4gICAgICBjb25zdCB1ID0gMSAtIHQ7XG4gICAgICBjb25zdCB1dSA9IHUgKiB1O1xuICAgICAgY29uc3QgdXV1ID0gdXUgKiB1O1xuXG4gICAgICBsZXQgeCA9IHV1dSAqIGN1cnZlLnN0YXJ0UG9pbnQueDtcbiAgICAgIHggKz0gMyAqIHV1ICogdCAqIGN1cnZlLmNvbnRyb2wxLng7XG4gICAgICB4ICs9IDMgKiB1ICogdHQgKiBjdXJ2ZS5jb250cm9sMi54O1xuICAgICAgeCArPSB0dHQgKiBjdXJ2ZS5lbmRQb2ludC54O1xuXG4gICAgICBsZXQgeSA9IHV1dSAqIGN1cnZlLnN0YXJ0UG9pbnQueTtcbiAgICAgIHkgKz0gMyAqIHV1ICogdCAqIGN1cnZlLmNvbnRyb2wxLnk7XG4gICAgICB5ICs9IDMgKiB1ICogdHQgKiBjdXJ2ZS5jb250cm9sMi55O1xuICAgICAgeSArPSB0dHQgKiBjdXJ2ZS5lbmRQb2ludC55O1xuXG4gICAgICBjb25zdCB3aWR0aCA9IE1hdGgubWluKFxuICAgICAgICBjdXJ2ZS5zdGFydFdpZHRoICsgdHR0ICogd2lkdGhEZWx0YSxcbiAgICAgICAgdGhpcy5tYXhXaWR0aCxcbiAgICAgICk7XG4gICAgICB0aGlzLl9kcmF3Q3VydmVTZWdtZW50KHgsIHksIHdpZHRoKTtcbiAgICB9XG5cbiAgICBjdHguY2xvc2VQYXRoKCk7XG4gICAgY3R4LmZpbGwoKTtcbiAgfVxuXG4gIHByaXZhdGUgX2RyYXdEb3Qoe1xuICAgIGNvbG9yLFxuICAgIHBvaW50LFxuICB9OiB7XG4gICAgY29sb3I6IHN0cmluZztcbiAgICBwb2ludDogQmFzaWNQb2ludDtcbiAgfSk6IHZvaWQge1xuICAgIGNvbnN0IGN0eCA9IHRoaXMuX2N0eDtcbiAgICBjb25zdCB3aWR0aCA9XG4gICAgICB0eXBlb2YgdGhpcy5kb3RTaXplID09PSAnZnVuY3Rpb24nID8gdGhpcy5kb3RTaXplKCkgOiB0aGlzLmRvdFNpemU7XG5cbiAgICBjdHguYmVnaW5QYXRoKCk7XG4gICAgdGhpcy5fZHJhd0N1cnZlU2VnbWVudChwb2ludC54LCBwb2ludC55LCB3aWR0aCk7XG4gICAgY3R4LmNsb3NlUGF0aCgpO1xuICAgIGN0eC5maWxsU3R5bGUgPSBjb2xvcjtcbiAgICBjdHguZmlsbCgpO1xuICB9XG5cbiAgcHJpdmF0ZSBfZnJvbURhdGEoXG4gICAgcG9pbnRHcm91cHM6IFBvaW50R3JvdXBbXSxcbiAgICBkcmF3Q3VydmU6IFNpZ25hdHVyZVBhZFsnX2RyYXdDdXJ2ZSddLFxuICAgIGRyYXdEb3Q6IFNpZ25hdHVyZVBhZFsnX2RyYXdEb3QnXSxcbiAgKTogdm9pZCB7XG4gICAgZm9yIChjb25zdCBncm91cCBvZiBwb2ludEdyb3Vwcykge1xuICAgICAgY29uc3QgeyBjb2xvciwgcG9pbnRzIH0gPSBncm91cDtcblxuICAgICAgaWYgKHBvaW50cy5sZW5ndGggPiAxKSB7XG4gICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgcG9pbnRzLmxlbmd0aDsgaiArPSAxKSB7XG4gICAgICAgICAgY29uc3QgYmFzaWNQb2ludCA9IHBvaW50c1tqXTtcbiAgICAgICAgICBjb25zdCBwb2ludCA9IG5ldyBQb2ludChiYXNpY1BvaW50LngsIGJhc2ljUG9pbnQueSwgYmFzaWNQb2ludC50aW1lKTtcblxuICAgICAgICAgIC8vIEFsbCBwb2ludHMgaW4gdGhlIGdyb3VwIGhhdmUgdGhlIHNhbWUgY29sb3IsIHNvIGl0J3MgZW5vdWdoIHRvIHNldFxuICAgICAgICAgIC8vIHBlbkNvbG9yIGp1c3QgYXQgdGhlIGJlZ2lubmluZy5cbiAgICAgICAgICB0aGlzLnBlbkNvbG9yID0gY29sb3I7XG5cbiAgICAgICAgICBpZiAoaiA9PT0gMCkge1xuICAgICAgICAgICAgdGhpcy5fcmVzZXQoKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBjb25zdCBjdXJ2ZSA9IHRoaXMuX2FkZFBvaW50KHBvaW50KTtcblxuICAgICAgICAgIGlmIChjdXJ2ZSkge1xuICAgICAgICAgICAgZHJhd0N1cnZlKHsgY29sb3IsIGN1cnZlIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5fcmVzZXQoKTtcblxuICAgICAgICBkcmF3RG90KHtcbiAgICAgICAgICBjb2xvcixcbiAgICAgICAgICBwb2ludDogcG9pbnRzWzBdLFxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cbiJdfQ==