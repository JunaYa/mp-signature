"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var bezier_1 = require("../../lib/bezier");
var point_1 = require("../../lib/point");
var ctx = null;
var isTouching = false;
var _isEmpty = false;
var minDistance = 0;
var backgroundColor = '#4f736d';
var pen = { color: '#333333', width: 1, _maxWidth: 10 };
var dpr = 1;
var _lastPoints = [];
var velocityFilterWeight = 0.7;
var _lastVelocity;
var _lastWidth;
var _maxWidth = 2.5;
var _minWidth = 0.5;
var _dotSize = (_minWidth + _maxWidth) / 2;
var _strokeMoveUpdate = null;
var timeLine = [];
Page({
    data: {},
    onLoad: function (options) {
        console.log('onLoad');
    },
    onReady: function () {
        this.initContext();
    },
    onShow: function () {
    },
    onHide: function () {
    },
    onUnload: function () {
    },
    initContext: function () {
        var _a = wx.getSystemInfoSync(), pixelRatio = _a.pixelRatio, windowWidth = _a.windowWidth, windowHeight = _a.windowHeight;
        dpr = pixelRatio;
        console.log('pixelRatio', pixelRatio);
        var query = wx.createSelectorQuery();
        query.select('#canvas').node().exec(function (res) {
            var canvas = res[0].node;
            console.log('canvas --- ', canvas);
            canvas.width = windowWidth;
            canvas.height = windowHeight;
            ctx = canvas.getContext('2d');
            console.log('ctx', ctx);
            ctx.fillStyle = backgroundColor;
            ctx.fillRect(16, 16, ctx.canvas.width - 32, ctx.canvas.height - 32);
        });
    },
    onTouchStart: function (event) {
        console.log('touch start -- ', event);
        isTouching = true;
        this._strokeBegin(event);
    },
    onTouchMove: function (event) {
        this._strokeUpdate(event);
    },
    onTouchEnd: function (event) {
        console.log('touch end --', event);
        isTouching = false;
        this._strokeEnd(event);
    },
    onTouchCancel: function (event) {
        console.log('touch cancel', event);
        isTouching = false;
        this._strokeEnd(event);
    },
    onError: function (event) {
        console.log('canvas error', event);
        isTouching = false;
        this._strokeEnd(event);
    },
    _strokeBegin: function (event) {
        var newPointGroup = {
            color: pen.color,
            points: [],
        };
        this._reset();
        timeLine.push(newPointGroup);
        var _a = event.touches[0], x = _a.x, y = _a.y;
        ctx.beginPath();
        this._moveTo(x, y);
        this._lineTo(x, y);
        this._strokeUpdate(event);
    },
    _strokeUpdate: function (event) {
        console.log('---------', event.touches[0]);
        var _a = event.touches[0], x = _a.x, y = _a.y;
        var point = this._createPoint(x, y);
        var lastPointGroup = timeLine[timeLine.length - 1];
        var lastPoints = lastPointGroup.points;
        var lastPoint = lastPoints.length > 0 && lastPoints[lastPoints.length - 1];
        var isLastPointTooClose = lastPoint ? point.distanceTo(lastPoint) <= minDistance : false;
        pen.color = lastPointGroup.color;
        if (!lastPoint || !(lastPoint && isLastPointTooClose)) {
            var curve = this._addPoint(point);
            if (!lastPoint) {
                this._drawDot(point);
            }
            else if (curve) {
                this._drawCurve(curve);
            }
        }
    },
    _strokeEnd: function (event) {
        console.log('end +++++++ ', event);
    },
    _calculateCurveWidths: function (startPoint, endPoint) {
        var velocity = velocityFilterWeight * endPoint.velocityFrom(startPoint) + (1 - velocityFilterWeight) * _lastVelocity;
        var newWidth = this._strokeWidth(velocity);
        var widths = {
            start: _lastWidth,
            end: newWidth,
        };
        _lastVelocity = velocity;
        _lastWidth = newWidth;
        return widths;
    },
    _strokeWidth: function (velocity) {
        return Math.max(_maxWidth / (velocity + 1), _minWidth);
    },
    _createPoint: function (x, y) {
        var left = 0;
        var top = 0;
        return new point_1.Point(x - left, y - top, new Date().getTime());
    },
    _addPoint: function (point) {
        _lastPoints.push(point);
        if (_lastPoints.length > 2) {
            if (_lastPoints.length === 3) {
                _lastPoints.unshift(_lastPoints[0]);
            }
            var widths = this._calculateCurveWidths(_lastPoints[1], _lastPoints[2]);
            var curve = bezier_1.Bezier.fromPoints(_lastPoints, widths);
            _lastPoints.shift();
            return curve;
        }
        return null;
    },
    _drawDot: function (point) {
        console.log('_drawDot ---- ', point);
        ctx.beginPath();
        var width = _dotSize;
        this._drawCurveSegment(point.x, point.y, width);
        ctx.closePath();
        ctx.fillStyle = pen.color;
        ctx.fill();
    },
    _drawCurveSegment: function (x, y, width) {
        ctx.moveTo(x, y);
        ctx.arc(x, y, width, 0, 2 * Math.PI, false);
        _isEmpty = false;
    },
    _drawCurve: function (curve) {
        console.log('_drawCurve ---- ', curve);
        var widthDelta = curve.endWidth - curve.startWidth;
        var drawSteps = Math.floor(curve.length()) * 2;
        ctx.beginPath();
        ctx.fillStyle = pen.color;
        for (var i = 0; i < drawSteps; i += 1) {
            var t = i / drawSteps;
            var tt = t * t;
            var ttt = tt * t;
            var u = 1 - t;
            var uu = u * u;
            var uuu = uu * u;
            var x = uuu * curve.startPoint.x;
            x += 3 * uu * t * curve.control1.x;
            x += 3 * u * tt * curve.control2.x;
            x += ttt * curve.endPoint.x;
            var y = uuu * curve.startPoint.y;
            y += 3 * uu * t * curve.control1.y;
            y += 3 * u * tt * curve.control2.y;
            y += ttt * curve.endPoint.y;
            var width = Math.min(curve.startWidth + ttt * widthDelta, pen._maxWidth);
            this._drawCurveSegment(x, y, width);
        }
        ctx.closePath();
        ctx.fill();
    },
    _lineTo: function (x, y) {
        ctx.lineTo(x * dpr, y * dpr);
    },
    _moveTo: function (x, y) {
        ctx.moveTo(x * dpr, y * dpr);
    },
    _reset: function () {
        ctx.fillStyle = pen.color;
    },
    _clear: function () {
        ctx.fillStyle = backgroundColor;
        ctx.clearRect(16, 16, ctx.canvas.width - 32, ctx.canvas.height - 32);
        ctx.fillRect(16, 16, ctx.canvas.width - 32, ctx.canvas.height - 32);
        timeLine = [];
        this._reset();
        _isEmpty = true;
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2lnbmF0dXJlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsic2lnbmF0dXJlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQ0EsMkNBQXlDO0FBQ3pDLHlDQUFtRDtBQUtuRCxJQUFJLEdBQUcsR0FBUSxJQUFJLENBQUE7QUFFbkIsSUFBSSxVQUFVLEdBQVksS0FBSyxDQUFBO0FBQy9CLElBQUksUUFBUSxHQUFZLEtBQUssQ0FBQTtBQUM3QixJQUFJLFdBQVcsR0FBVyxDQUFDLENBQUE7QUFDM0IsSUFBSSxlQUFlLEdBQUcsU0FBUyxDQUFBO0FBQy9CLElBQUksR0FBRyxHQUFHLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsQ0FBQyxFQUFFLFNBQVMsRUFBRSxFQUFFLEVBQUUsQ0FBQTtBQUN2RCxJQUFJLEdBQUcsR0FBRyxDQUFDLENBQUE7QUFDWCxJQUFJLFdBQVcsR0FBWSxFQUFFLENBQUE7QUFDN0IsSUFBSSxvQkFBb0IsR0FBVyxHQUFHLENBQUE7QUFDdEMsSUFBSSxhQUFxQixDQUFBO0FBQ3pCLElBQUksVUFBa0IsQ0FBQTtBQUN0QixJQUFJLFNBQVMsR0FBVyxHQUFHLENBQUE7QUFDM0IsSUFBSSxTQUFTLEdBQVcsR0FBRyxDQUFBO0FBQzNCLElBQUksUUFBUSxHQUFXLENBQUMsU0FBUyxHQUFHLFNBQVMsQ0FBQyxHQUFHLENBQUMsQ0FBQTtBQUNsRCxJQUFJLGlCQUFpQixHQUFRLElBQUksQ0FBQTtBQUdqQyxJQUFJLFFBQVEsR0FBVSxFQUFFLENBQUE7QUFFeEIsSUFBSSxDQUFDO0lBS0gsSUFBSSxFQUFFLEVBRUw7SUFLRCxNQUFNLEVBQUUsVUFBVSxPQUFPO1FBQ3ZCLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUE7SUFDdkIsQ0FBQztJQUtELE9BQU8sRUFBRTtRQUNQLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQTtJQUNwQixDQUFDO0lBS0QsTUFBTSxFQUFFO0lBRVIsQ0FBQztJQUtELE1B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ZUFBZSxDQUFDO1FBQ2hDLEdBQUcsQ0FBQyxTQUFTLENBQUMsRUFBRSxFQUFFLEVBQUUsRUFBRSxHQUFHLENBQUMsTUFBTSxDQUFDLEtBQUssR0FBRyxFQUFFLEVBQUUsR0FBRyxDQUFDLE1BQU0sQ0FBQyxNQUFNLEdBQUcsRUFBRSxDQUFDLENBQUE7UUFDcEUsR0FBRyxDQUFDLFFBQVEsQ0FBQyxFQUFFLEVBQUUsRUFBRSxFQUFFLEdBQUcsQ0FBQyxNQUFNLENBQUMsS0FBSyxHQUFHLEVBQUUsRUFBRSxHQUFHLENBQUMsTUFBTSxDQUFDLE1BQU0sR0FBRyxFQUFFLENBQUMsQ0FBQTtRQUNuRSxRQUFRLEdBQUcsRUFBRSxDQUFBO1FBQ2IsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFBO1FBQ2IsUUFBUSxHQUFHLElBQUksQ0FBQTtJQUNqQixDQUFDO0NBRUYsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiLy8gbWluaXByb2dyYW0vcGFnZXMvc2lnbmF0dXJlLmpzXG5pbXBvcnQgeyBCZXppZXIgfSBmcm9tICcuLi8uLi9saWIvYmV6aWVyJ1xuaW1wb3J0IHsgQmFzaWNQb2ludCwgUG9pbnQgfSBmcm9tICcuLi8uLi9saWIvcG9pbnQnXG5pbXBvcnQgeyB0aHJvdHRsZSB9IGZyb20gJy4uLy4uL2xpYi90aHJvdHRsZSdcblxuXG4vLyBjYW52YXMgY29udGV4dFxubGV0IGN0eDogYW55ID0gbnVsbFxuLy8gdG91Y2ggZHJhd2luZ1xubGV0IGlzVG91Y2hpbmc6IGJvb2xlYW4gPSBmYWxzZVxubGV0IF9pc0VtcHR5OiBib29sZWFuID0gZmFsc2VcbmxldCBtaW5EaXN0YW5jZTogbnVtYmVyID0gMFxubGV0IGJhY2tncm91bmRDb2xvciA9ICcjNGY3MzZkJ1xubGV0IHBlbiA9IHsgY29sb3I6ICcjMzMzMzMzJywgd2lkdGg6IDEsIF9tYXhXaWR0aDogMTAgfVxubGV0IGRwciA9IDFcbmxldCBfbGFzdFBvaW50czogUG9pbnRbXSA9IFtdXG5sZXQgdmVsb2NpdHlGaWx0ZXJXZWlnaHQ6IG51bWJlciA9IDAuN1xubGV0IF9sYXN0VmVsb2NpdHk6IG51bWJlclxubGV0IF9sYXN0V2lkdGg6IG51bWJlclxubGV0IF9tYXhXaWR0aDogbnVtYmVyID0gMi41XG5sZXQgX21pbldpZHRoOiBudW1iZXIgPSAwLjVcbmxldCBfZG90U2l6ZTogbnVtYmVyID0gKF9taW5XaWR0aCArIF9tYXhXaWR0aCkgLyAyXG5sZXQgX3N0cm9rZU1vdmVVcGRhdGU6IGFueSA9IG51bGxcblxuLy8g5pe26Ze06L2077yM6K6w5b2V5pON5L2c5q2l6aqk5pWw5o2uXG5sZXQgdGltZUxpbmU6IGFueVtdID0gW11cblxuUGFnZSh7XG5cbiAgLyoqXG4gICAqIFBhZ2UgaW5pdGlhbCBkYXRhXG4gICAqL1xuICBkYXRhOiB7XG5cbiAgfSxcblxuICAvKipcbiAgICogTGlmZWN5Y2xlIGZ1bmN0aW9uLS1DYWxsZWQgd2hlbiBwYWdlIGxvYWRcbiAgICovXG4gIG9uTG9hZDogZnVuY3Rpb24gKG9wdGlvbnMpIHtcbiAgICBjb25zb2xlLmxvZygnb25Mb2FkJylcbiAgfSxcblxuICAvKipcbiAgICogTGlmZWN5Y2xlIGZ1bmN0aW9uLS1DYWxsZWQgd2hlbiBwYWdlIGlzIGluaXRpYWxseSByZW5kZXJlZFxuICAgKi9cbiAgb25SZWFkeTogZnVuY3Rpb24gKCkge1xuICAgIHRoaXMuaW5pdENvbnRleHQoKVxuICB9LFxuXG4gIC8qKlxuICAgKiBMaWZlY3ljbGUgZnVuY3Rpb24tLUNhbGxlZCB3aGVuIHBhZ2Ugc2hvd1xuICAgKi9cbiAgb25TaG93OiBmdW5jdGlvbiAoKSB7XG5cbiAgfSxcblxuICAvKipcbiAgICogTGlmZWN5Y2xlIGZ1bmN0aW9uLS1DYWxsZWQgd2hlbiBwYWdlIGhpZGVcbiAgICovXG4gIG9uSGlkZTogZnVuY3Rpb24gKCkge1xuXG4gIH0sXG5cbiAgLyoqXG4gICAqIExpZmVjeWNsZSBmdW5jdGlvbi0tQ2FsbGVkIHdoZW4gcGFnZSB1bmxvYWRcbiAgICovXG4gIG9uVW5sb2FkOiBmdW5jdGlvbiAoKSB7XG5cbiAgfSxcblxuICAvKipcbiAgICogaW5pdCBjYW52YXMgY29udGV4dFxuICAgKi9cbiAgaW5pdENvbnRleHQgKCkge1xuICAgIGNvbnN0IHsgcGl4ZWxSYXRpbywgd2luZG93V2lkdGgsIHdpbmRvd0hlaWdodCB9ID0gd3guZ2V0U3lzdGVtSW5mb1N5bmMoKVxuICAgIGRwciA9IHBpeGVsUmF0aW9cbiAgICBjb25zb2xlLmxvZygncGl4ZWxSYXRpbycsIHBpeGVsUmF0aW8pXG5cbiAgICBjb25zdCBxdWVyeSA9IHd4LmNyZWF0ZVNlbGVjdG9yUXVlcnkoKVxuICAgIHF1ZXJ5LnNlbGVjdCgnI2NhbnZhcycpLm5vZGUoKS5leGVjKChyZXMpID0+IHtcbiAgICAgIGNvbnN0IGNhbnZhcyA9IHJlc1swXS5ub2RlXG4gICAgICBjb25zb2xlLmxvZygnY2FudmFzIC0tLSAnLCBjYW52YXMpXG4gICAgICAvLyBjYW52YXMud2lkdGggPSB3aW5kb3dXaWR0aCAqIGRwclxuICAgICAgLy8gY2FudmFzLmhlaWdodCA9IHdpbmRvd0hlaWdodCAqIGRwclxuICAgICAgY2FudmFzLndpZHRoID0gd2luZG93V2lkdGhcbiAgICAgIGNhbnZhcy5oZWlnaHQgPSB3aW5kb3dIZWlnaHRcblxuICAgICAgY3R4ID0gY2FudmFzLmdldENvbnRleHQoJzJkJylcbiAgICAgIC8vIGN0eC5zY2FsZShwaXhlbFJhdGlvLCBwaXhlbFJhdGlvKVxuICAgICAgY29uc29sZS5sb2coJ2N0eCcsIGN0eClcblxuICAgICAgY3R4LmZpbGxTdHlsZSA9IGJhY2tncm91bmRDb2xvclxuICAgICAgY3R4LmZpbGxSZWN0KDE2LCAxNiwgY3R4LmNhbnZhcy53aWR0aCAtIDMyLCBjdHguY2FudmFzLmhlaWdodCAtIDMyKVxuICAgIH0pXG4gIH0sXG5cbiAgb25Ub3VjaFN0YXJ0IChldmVudDogYW55KSA6IHZvaWQge1xuICAgIGNvbnNvbGUubG9nKCd0b3VjaCBzdGFydCAtLSAnLCBldmVudClcbiAgICBpc1RvdWNoaW5nID0gdHJ1ZVxuICAgIHRoaXMuX3N0cm9rZUJlZ2luKGV2ZW50KVxuICB9LFxuXG4gIG9uVG91Y2hNb3ZlIChldmVudDogYW55KSA6IHZvaWQge1xuICAgIC8vIGNvbnNvbGUubG9nKCd0b3VjaCBtb3ZlIC0tJywgZXZlbnQpXG4gICAgdGhpcy5fc3Ryb2tlVXBkYXRlKGV2ZW50KVxuICB9LFxuXG4gIG9uVG91Y2hFbmQgKGV2ZW50OiBhbnkpIDogdm9pZCB7XG4gICAgY29uc29sZS5sb2coJ3RvdWNoIGVuZCAtLScsIGV2ZW50KVxuICAgIGlzVG91Y2hpbmcgPSBmYWxzZVxuICAgIHRoaXMuX3N0cm9rZUVuZChldmVudClcbiAgfSxcblxuICBvblRvdWNoQ2FuY2VsIChldmVudDogYW55KSA6IHZvaWQge1xuICAgIGNvbnNvbGUubG9nKCd0b3VjaCBjYW5jZWwnLCBldmVudClcbiAgICBpc1RvdWNoaW5nID0gZmFsc2VcbiAgICB0aGlzLl9zdHJva2VFbmQoZXZlbnQpXG4gIH0sXG5cbiAgb25FcnJvciAoZXZlbnQ6IGFueSkge1xuICAgIGNvbnNvbGUubG9nKCdjYW52YXMgZXJyb3InLCBldmVudClcbiAgICBpc1RvdWNoaW5nID0gZmFsc2VcbiAgICB0aGlzLl9zdHJva2VFbmQoZXZlbnQpXG4gIH0sXG5cbiAgX3N0cm9rZUJlZ2luIChldmVudD86IGFueSkgOiB2b2lkIHtcbiAgICBjb25zdCBuZXdQb2ludEdyb3VwID0ge1xuICAgICAgY29sb3I6IHBlbi5jb2xvcixcbiAgICAgIHBvaW50czogW10sXG4gICAgfTtcblxuICAgIHRoaXMuX3Jlc2V0KCk7XG4gICAgdGltZUxpbmUucHVzaChuZXdQb2ludEdyb3VwKTtcbiAgICBjb25zdCB7eCwgeX0gPSBldmVudC50b3VjaGVzWzBdXG4gICAgY3R4LmJlZ2luUGF0aCgpXG4gICAgdGhpcy5fbW92ZVRvKHgsIHkpXG4gICAgdGhpcy5fbGluZVRvKHgsIHkpXG4gICAgdGhpcy5fc3Ryb2tlVXBkYXRlKGV2ZW50KVxuICB9LFxuXG4gIF9zdHJva2VVcGRhdGUgKGV2ZW50OiBhbnkpIDogdm9pZCB7XG4gICAgLy8gaWYgKHRpbWVMaW5lLmxlbmd0aCA9PT0gMCkge1xuICAgIC8vICAgdGhpcy5fc3Ryb2tlVXBkYXRlKGV2ZW50KVxuICAgIC8vICAgcmV0dXJuXG4gICAgLy8gfVxuICAgIGNvbnNvbGUubG9nKCctLS0tLS0tLS0nLCBldmVudC50b3VjaGVzWzBdKVxuICAgIGNvbnN0IHt4LCB5fSA9IGV2ZW50LnRvdWNoZXNbMF1cblxuICAgIGNvbnN0IHBvaW50ID0gdGhpcy5fY3JlYXRlUG9pbnQoeCwgeSlcbiAgICBjb25zdCBsYXN0UG9pbnRHcm91cCA9IHRpbWVMaW5lW3RpbWVMaW5lLmxlbmd0aCAtIDFdXG4gICAgY29uc3QgbGFzdFBvaW50cyA9IGxhc3RQb2ludEdyb3VwLnBvaW50c1xuICAgIGNvbnN0IGxhc3RQb2ludCA9IGxhc3RQb2ludHMubGVuZ3RoID4gMCAmJiBsYXN0UG9pbnRzW2xhc3RQb2ludHMubGVuZ3RoIC0gMV1cbiAgICBjb25zdCBpc0xhc3RQb2ludFRvb0Nsb3NlID0gbGFzdFBvaW50ID8gcG9pbnQuZGlzdGFuY2VUbyhsYXN0UG9pbnQpIDw9IG1pbkRpc3RhbmNlIDogZmFsc2VcbiAgICBwZW4uY29sb3IgPSBsYXN0UG9pbnRHcm91cC5jb2xvclxuXG4gICAgaWYgKCFsYXN0UG9pbnQgfHwgIShsYXN0UG9pbnQgJiYgaXNMYXN0UG9pbnRUb29DbG9zZSkpIHtcbiAgICAgIGNvbnN0IGN1cnZlID0gdGhpcy5fYWRkUG9pbnQocG9pbnQpXG4gICAgICBpZiAoIWxhc3RQb2ludCkge1xuICAgICAgICB0aGlzLl9kcmF3RG90KHBvaW50KVxuICAgICAgfSBlbHNlIGlmIChjdXJ2ZSkge1xuICAgICAgICB0aGlzLl9kcmF3Q3VydmUoY3VydmUpXG4gICAgICB9XG4gICAgfVxuICB9LFxuXG4gIF9zdHJva2VFbmQgKGV2ZW50OiBhbnkpIDogdm9pZCB7XG4gICAgY29uc29sZS5sb2coJ2VuZCArKysrKysrICcsIGV2ZW50KVxuICAgIC8vIHRoaXMuX3N0cm9rZVVwZGF0ZShldmVudClcbiAgfSxcblxuICBfY2FsY3VsYXRlQ3VydmVXaWR0aHMgKHN0YXJ0UG9pbnQ6IFBvaW50LCBlbmRQb2ludDogUG9pbnQpIDogeyBzdGFydDogbnVtYmVyOyBlbmQ6IG51bWJlciB9IHtcbiAgICBjb25zdCB2ZWxvY2l0eSA9IHZlbG9jaXR5RmlsdGVyV2VpZ2h0ICogZW5kUG9pbnQudmVsb2NpdHlGcm9tKHN0YXJ0UG9pbnQpICsgKDEgLSB2ZWxvY2l0eUZpbHRlcldlaWdodCkgKiBfbGFzdFZlbG9jaXR5XG4gICAgY29uc3QgbmV3V2lkdGggPSB0aGlzLl9zdHJva2VXaWR0aCh2ZWxvY2l0eSlcbiAgICBjb25zdCB3aWR0aHMgPSB7XG4gICAgICBzdGFydDogX2xhc3RXaWR0aCxcbiAgICAgIGVuZDogbmV3V2lkdGgsXG4gICAgfVxuICAgIF9sYXN0VmVsb2NpdHkgPSB2ZWxvY2l0eVxuICAgIF9sYXN0V2lkdGggPSBuZXdXaWR0aFxuICAgIHJldHVybiB3aWR0aHNcbiAgfSxcblxuICBfc3Ryb2tlV2lkdGggKHZlbG9jaXR5OiBudW1iZXIpIHtcbiAgICByZXR1cm4gTWF0aC5tYXgoX21heFdpZHRoIC8gKHZlbG9jaXR5ICsgMSksIF9taW5XaWR0aCk7XG4gIH0sXG5cbiAgX2NyZWF0ZVBvaW50KHg6IG51bWJlciwgeTogbnVtYmVyKTogUG9pbnQge1xuICAgIC8vIGNvbnN0IHtsZWZ0LCB0b3B9ID0gY3R4LmNhbnZhcztcbiAgICBjb25zdCBsZWZ0ID0gMDtcbiAgICBjb25zdCB0b3AgPSAwO1xuICAgIHJldHVybiBuZXcgUG9pbnQoeCAtIGxlZnQsIHkgLSB0b3AsIG5ldyBEYXRlKCkuZ2V0VGltZSgpKTtcbiAgfSxcblxuICBfYWRkUG9pbnQocG9pbnQ6IFBvaW50KSA6IEJlemllciB8IG51bGwge1xuICAgIF9sYXN0UG9pbnRzLnB1c2gocG9pbnQpO1xuXG4gICAgaWYgKF9sYXN0UG9pbnRzLmxlbmd0aCA+IDIpIHtcbiAgICAgIC8vIFRvIHJlZHVjZSB0aGUgaW5pdGlhbCBsYWcgbWFrZSBpdCB3b3JrIHdpdGggMyBwb2ludHNcbiAgICAgIC8vIGJ5IGNvcHlpbmcgdGhlIGZpcnN0IHBvaW50IHRvIHRoZSBiZWdpbm5pbmcuXG4gICAgICBpZiAoX2xhc3RQb2ludHMubGVuZ3RoID09PSAzKSB7XG4gICAgICAgIF9sYXN0UG9pbnRzLnVuc2hpZnQoX2xhc3RQb2ludHNbMF0pO1xuICAgICAgfVxuXG4gICAgICAvLyBfcG9pbnRzIGFycmF5IHdpbGwgYWx3YXlzIGhhdmUgNCBwb2ludHMgaGVyZS5cbiAgICAgIGNvbnN0IHdpZHRocyA9IHRoaXMuX2NhbGN1bGF0ZUN1cnZlV2lkdGhzKF9sYXN0UG9pbnRzWzFdLCBfbGFzdFBvaW50c1syXSk7XG4gICAgICBjb25zdCBjdXJ2ZSA9IEJlemllci5mcm9tUG9pbnRzKF9sYXN0UG9pbnRzLCB3aWR0aHMpO1xuXG4gICAgICAvLyBSZW1vdmUgdGhlIGZpcnN0IGVsZW1lbnQgZnJvbSB0aGUgbGlzdCwgc28gdGhhdCB0aGVyZSBhcmUgbm8gbW9yZSB0aGFuIDQgcG9pbnRzIGF0IGFueSB0aW1lLlxuICAgICAgX2xhc3RQb2ludHMuc2hpZnQoKTtcblxuICAgICAgcmV0dXJuIGN1cnZlO1xuICAgIH1cblxuICAgIHJldHVybiBudWxsO1xuICB9LFxuXG4gIF9kcmF3RG90IChwb2ludDogQmFzaWNQb2ludCkgOiB2b2lkIHtcbiAgICBjb25zb2xlLmxvZygnX2RyYXdEb3QgLS0tLSAnLCBwb2ludClcbiAgICBjdHguYmVnaW5QYXRoKCk7XG4gICAgY29uc3Qgd2lkdGggPSBfZG90U2l6ZVxuICAgIHRoaXMuX2RyYXdDdXJ2ZVNlZ21lbnQocG9pbnQueCwgcG9pbnQueSwgd2lkdGgpO1xuICAgIGN0eC5jbG9zZVBhdGgoKTtcbiAgICBjdHguZmlsbFN0eWxlID0gcGVuLmNvbG9yO1xuICAgIGN0eC5maWxsKCk7XG4gIH0sXG5cbiAgX2RyYXdDdXJ2ZVNlZ21lbnQgKHg6IG51bWJlciwgeTpudW1iZXIsIHdpZHRoOiBudW1iZXIpIHtcbiAgICBjdHgubW92ZVRvKHgsIHkpXG4gICAgY3R4LmFyYyh4LCB5LCB3aWR0aCwgMCwgMiAqIE1hdGguUEksIGZhbHNlKVxuICAgIF9pc0VtcHR5ID0gZmFsc2VcbiAgfSxcblxuICBfZHJhd0N1cnZlKGN1cnZlOiBCZXppZXIpOiB2b2lkIHtcbiAgICBjb25zb2xlLmxvZygnX2RyYXdDdXJ2ZSAtLS0tICcsIGN1cnZlKVxuICAgIGNvbnN0IHdpZHRoRGVsdGEgPSBjdXJ2ZS5lbmRXaWR0aCAtIGN1cnZlLnN0YXJ0V2lkdGhcbiAgICAvLyAnMicgaXMganVzdCBhbiBhcmJpdHJhcnkgbnVtYmVyIGhlcmUuIElmIG9ubHkgbGVuZ2h0IGlzIHVzZWQsIHRoZW5cbiAgICAvLyB0aGVyZSBhcmUgZ2FwcyBiZXR3ZWVuIGN1cnZlIHNlZ21lbnRzIDovXG4gICAgY29uc3QgZHJhd1N0ZXBzID0gTWF0aC5mbG9vcihjdXJ2ZS5sZW5ndGgoKSkgKiAyXG5cbiAgICBjdHguYmVnaW5QYXRoKClcbiAgICBjdHguZmlsbFN0eWxlID0gcGVuLmNvbG9yXG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGRyYXdTdGVwczsgaSArPSAxKSB7XG4gICAgICAvLyBDYWxjdWxhdGUgdGhlIEJlemllciAoeCwgeSkgY29vcmRpbmF0ZSBmb3IgdGhpcyBzdGVwLlxuICAgICAgY29uc3QgdCA9IGkgLyBkcmF3U3RlcHNcbiAgICAgIGNvbnN0IHR0ID0gdCAqIHRcbiAgICAgIGNvbnN0IHR0dCA9IHR0ICogdFxuICAgICAgY29uc3QgdSA9IDEgLSB0XG4gICAgICBjb25zdCB1dSA9IHUgKiB1XG4gICAgICBjb25zdCB1dXUgPSB1dSAqIHVcblxuICAgICAgbGV0IHggPSB1dXUgKiBjdXJ2ZS5zdGFydFBvaW50LnhcbiAgICAgIHggKz0gMyAqIHV1ICogdCAqIGN1cnZlLmNvbnRyb2wxLnhcbiAgICAgIHggKz0gMyAqIHUgKiB0dCAqIGN1cnZlLmNvbnRyb2wyLnhcbiAgICAgIHggKz0gdHR0ICogY3VydmUuZW5kUG9pbnQueFxuXG4gICAgICBsZXQgeSA9IHV1dSAqIGN1cnZlLnN0YXJ0UG9pbnQueVxuICAgICAgeSArPSAzICogdXUgKiB0ICogY3VydmUuY29udHJvbDEueVxuICAgICAgeSArPSAzICogdSAqIHR0ICogY3VydmUuY29udHJvbDIueVxuICAgICAgeSArPSB0dHQgKiBjdXJ2ZS5lbmRQb2ludC55XG5cbiAgICAgIGNvbnN0IHdpZHRoID0gTWF0aC5taW4oXG4gICAgICAgIGN1cnZlLnN0YXJ0V2lkdGggKyB0dHQgKiB3aWR0aERlbHRhLFxuICAgICAgICBwZW4uX21heFdpZHRoLFxuICAgICAgKTtcbiAgICAgIHRoaXMuX2RyYXdDdXJ2ZVNlZ21lbnQoeCwgeSwgd2lkdGgpO1xuICAgIH1cblxuICAgIGN0eC5jbG9zZVBhdGgoKTtcbiAgICBjdHguZmlsbCgpO1xuICB9LFxuXG4gIF9saW5lVG8gKHg6IG51bWJlciwgeTogbnVtYmVyKSA6IHZvaWQge1xuICAgIGN0eC5saW5lVG8oeCAqIGRwciwgeSAqIGRwcilcbiAgfSxcblxuICBfbW92ZVRvICh4OiBudW1iZXIsIHk6IG51bWJlcikgOiB2b2lkIHtcbiAgICBjdHgubW92ZVRvKHggKiBkcHIsIHkgKiBkcHIpXG4gIH0sXG5cbiAgX3Jlc2V0ICgpIDogdm9pZCB7XG4gICAgLy8gdGhpcy5fbGFzdFBvaW50cyA9IFtdXG4gICAgLy8gdGhpcy5fbGFzdFZlbG9jaXR5ID0gMFxuICAgIC8vIHRoaXMuX2xhc3RXaWR0aCA9ICh0aGlzLl9taW5XaWR0aCArIHRoaXMuX21heFdpZHRoKSAvIDJcbiAgICBjdHguZmlsbFN0eWxlID0gcGVuLmNvbG9yXG4gIH0sXG5cbiAgX2NsZWFyICgpIDogdm9pZCB7XG4gICAgY3R4LmZpbGxTdHlsZSA9IGJhY2tncm91bmRDb2xvcjtcbiAgICBjdHguY2xlYXJSZWN0KDE2LCAxNiwgY3R4LmNhbnZhcy53aWR0aCAtIDMyLCBjdHguY2FudmFzLmhlaWdodCAtIDMyKVxuICAgIGN0eC5maWxsUmVjdCgxNiwgMTYsIGN0eC5jYW52YXMud2lkdGggLSAzMiwgY3R4LmNhbnZhcy5oZWlnaHQgLSAzMilcbiAgICB0aW1lTGluZSA9IFtdXG4gICAgdGhpcy5fcmVzZXQoKVxuICAgIF9pc0VtcHR5ID0gdHJ1ZVxuICB9LFxuXG59KSJdfQ==