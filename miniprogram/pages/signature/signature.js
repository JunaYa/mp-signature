"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var bezier_1 = require("../../lib/bezier");
var point_1 = require("../../lib/point");
var throttle_1 = require("../../lib/throttle");
var ctx = null;
var isTouching = false;
var _isEmpty = false;
var minDistance = 5;
var backgroundColor = '#4f736d';
var pen = { color: '#333333', width: 1, _maxWidth: 10 };
var dpr = 1;
var _maxWidth = 2.5;
var _minWidth = 0.5;
var _dotSize = (_minWidth + _maxWidth) / 2;
var _lastPoints = [];
var velocityFilterWeight = 0.7;
var _lastVelocity = 0;
var _lastWidth = (_minWidth + _maxWidth) / 2;
var _strokeMoveUpdate = null;
var timeLine = [];
Page({
    data: {},
    onLoad: function (options) {
        console.log('onLoad');
    },
    onReady: function () {
        this.initContext();
        _strokeMoveUpdate = throttle_1.throttle(this._strokeUpdate, 16);
    },
    onShow: function () {
    },
    onHide: function () {
    },
    onUnload: function () {
    },
    initContext: function () {
        var _a = wx.getSystemInfoSync(), pixelRatio = _a.pixelRatio, windowWidth = _a.windowWidth, windowHeight = _a.windowHeight;
        dpr = pixelRatio;
        console.log('pixelRatio', pixelRatio);
        var query = wx.createSelectorQuery();
        query.select('#canvas').node().exec(function (res) {
            var canvas = res[0].node;
            console.log('canvas --- ', canvas);
            canvas.width = windowWidth;
            canvas.height = windowHeight;
            ctx = canvas.getContext('2d');
            console.log('ctx', ctx);
            ctx.fillStyle = backgroundColor;
            ctx.fillRect(16, 16, ctx.canvas.width - 32, ctx.canvas.height - 32);
        });
    },
    onTouchStart: function (event) {
        console.log('touch start -- ', event);
        isTouching = true;
        this._strokeBegin(event);
    },
    onTouchMove: function (event) {
        this._strokeUpdate(event);
    },
    onTouchEnd: function (event) {
        console.log('touch end --', event);
        isTouching = false;
        this._strokeEnd(event);
    },
    onTouchCancel: function (event) {
        console.log('touch cancel', event);
        isTouching = false;
        this._strokeEnd(event);
    },
    onError: function (event) {
        console.log('canvas error', event);
        isTouching = false;
        this._strokeEnd(event);
    },
    _strokeBegin: function (event) {
        var newPointGroup = {
            color: pen.color,
            points: [],
        };
        timeLine.push(newPointGroup);
        this._reset();
        this._strokeUpdate(event);
    },
    _strokeUpdate: function (event) {
        if (timeLine.length === 0) {
            this._strokeBegin(event);
            return;
        }
        var _a = event.touches[0], x = _a.x, y = _a.y;
        console.log('timeLine', timeLine);
        var point = this._createPoint(x, y);
        var lastPointGroup = timeLine[timeLine.length - 1];
        var lastPoints = lastPointGroup.points;
        var lastPoint = lastPoints.length > 0 && lastPoints[lastPoints.length - 1];
        var isLastPointTooClose = lastPoint ? point.distanceTo(lastPoint) <= minDistance : false;
        pen.color = lastPointGroup.color;
        console.log('lastPoint', lastPoint);
        console.log('isLastPointTooClose', isLastPointTooClose);
        if (!lastPoint || !(lastPoint && isLastPointTooClose)) {
            var curve = this._addPoint(point);
            if (!curve) {
                this._drawDot(point);
            }
            else if (curve) {
                this._drawCurve(curve);
            }
        }
    },
    _strokeEnd: function (event) {
        console.log('end +++++++ ', event);
    },
    _calculateCurveWidths: function (startPoint, endPoint) {
        var velocity = velocityFilterWeight * endPoint.velocityFrom(startPoint) + (1 - velocityFilterWeight) * _lastVelocity;
        var newWidth = this._strokeWidth(velocity);
        var widths = {
            start: _lastWidth,
            end: newWidth,
        };
        _lastVelocity = velocity;
        _lastWidth = newWidth;
        return widths;
    },
    _strokeWidth: function (velocity) {
        return Math.max(_maxWidth / (velocity + 1), _minWidth);
    },
    _createPoint: function (x, y) {
        var left = 0;
        var top = 0;
        return new point_1.Point(x - left, y - top, new Date().getTime());
    },
    _addPoint: function (point) {
        _lastPoints.push(point);
        if (_lastPoints.length > 2) {
            if (_lastPoints.length === 3) {
                _lastPoints.unshift(_lastPoints[0]);
            }
            var widths = this._calculateCurveWidths(_lastPoints[1], _lastPoints[2]);
            var curve = bezier_1.Bezier.fromPoints(_lastPoints, widths);
            _lastPoints.shift();
            return curve;
        }
        return null;
    },
    _drawDot: function (point) {
        ctx.beginPath();
        var width = _dotSize;
        this._drawCurveSegment(point.x, point.y, width);
        ctx.closePath();
        ctx.fillStyle = pen.color;
        ctx.fill();
    },
    _drawCurveSegment: function (x, y, width) {
        ctx.moveTo(x, y);
        ctx.arc(x, y, width, 0, 2 * Math.PI, false);
        _isEmpty = false;
    },
    _drawCurve: function (curve) {
        console.log('_drawCurve ---- ', curve);
        var widthDelta = curve.endWidth - curve.startWidth;
        var drawSteps = Math.floor(curve.length()) * 2;
        ctx.beginPath();
        ctx.fillStyle = pen.color;
        for (var i = 0; i < drawSteps; i += 1) {
            var t = i / drawSteps;
            var tt = t * t;
            var ttt = tt * t;
            var u = 1 - t;
            var uu = u * u;
            var uuu = uu * u;
            var x = uuu * curve.startPoint.x;
            x += 3 * uu * t * curve.control1.x;
            x += 3 * u * tt * curve.control2.x;
            x += ttt * curve.endPoint.x;
            var y = uuu * curve.startPoint.y;
            y += 3 * uu * t * curve.control1.y;
            y += 3 * u * tt * curve.control2.y;
            y += ttt * curve.endPoint.y;
            var width = Math.min(curve.startWidth + ttt * widthDelta, pen._maxWidth);
            this._drawCurveSegment(x, y, width);
        }
        ctx.closePath();
        ctx.fill();
    },
    _lineTo: function (x, y) {
        ctx.lineTo(x * dpr, y * dpr);
    },
    _moveTo: function (x, y) {
        ctx.moveTo(x * dpr, y * dpr);
    },
    _reset: function () {
        _lastPoints = [];
        _lastVelocity = 0;
        _lastWidth = (_minWidth + _maxWidth) / 2;
        ctx.fillStyle = pen.color;
    },
    _clear: function () {
        ctx.fillStyle = backgroundColor;
        ctx.clearRect(16, 16, ctx.canvas.width - 32, ctx.canvas.height - 32);
        ctx.fillRect(16, 16, ctx.canvas.width - 32, ctx.canvas.height - 32);
        timeLine = [];
        this._reset();
        _isEmpty = true;
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2lnbmF0dXJlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsic2lnbmF0dXJlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQ0EsMkNBQXlDO0FBQ3pDLHlDQUFtRDtBQUNuRCwrQ0FBNkM7QUFTN0MsSUFBSSxHQUFHLEdBQVEsSUFBSSxDQUFBO0FBRW5CLElBQUksVUFBVSxHQUFZLEtBQUssQ0FBQTtBQUMvQixJQUFJLFFBQVEsR0FBWSxLQUFLLENBQUE7QUFDN0IsSUFBSSxXQUFXLEdBQVcsQ0FBQyxDQUFBO0FBQzNCLElBQUksZUFBZSxHQUFHLFNBQVMsQ0FBQTtBQUMvQixJQUFJLEdBQUcsR0FBRyxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLENBQUMsRUFBRSxTQUFTLEVBQUUsRUFBRSxFQUFFLENBQUE7QUFDdkQsSUFBSSxHQUFHLEdBQUcsQ0FBQyxDQUFBO0FBRVgsSUFBSSxTQUFTLEdBQVcsR0FBRyxDQUFBO0FBQzNCLElBQUksU0FBUyxHQUFXLEdBQUcsQ0FBQTtBQUMzQixJQUFJLFFBQVEsR0FBVyxDQUFDLFNBQVMsR0FBRyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUE7QUFFbEQsSUFBSSxXQUFXLEdBQVksRUFBRSxDQUFBO0FBQzdCLElBQUksb0JBQW9CLEdBQVcsR0FBRyxDQUFBO0FBQ3RDLElBQUksYUFBYSxHQUFXLENBQUMsQ0FBQTtBQUM3QixJQUFJLFVBQVUsR0FBVyxDQUFDLFNBQVMsR0FBRyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUE7QUFDcEQsSUFBSSxpQkFBaUIsR0FBUSxJQUFJLENBQUE7QUFHakMsSUFBSSxRQUFRLEdBQWlCLEVBQUUsQ0FBQTtBQUUvQixJQUFJLENBQUM7SUFLSCxJQUFJLEVBQUUsRUFFTDtJQUtELE1BQU0sRUFBRSxVQUFVLE9BQU87UUFDdkIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQTtJQUN2QixDQUFDO0lBS0QsT0FBTyxFQUFFO1FBQ1AsSUFBSSxD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QUE7UUFDaEIsYUFBYSxHQUFHLENBQUMsQ0FBQTtRQUNqQixVQUFVLEdBQUcsQ0FBQyxTQUFTLEdBQUcsU0FBUyxDQUFDLEdBQUcsQ0FBQyxDQUFBO1FBQ3hDLEdBQUcsQ0FBQyxTQUFTLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQTtJQUMzQixDQUFDO0lBRUQsTUFBTSxFQUFOO1FBQ0UsR0FBRyxDQUFDLFNBQVMsR0FBRyxlQUFlLENBQUM7UUFDaEMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxFQUFFLEVBQUUsRUFBRSxFQUFFLEdBQUcsQ0FBQyxNQUFNLENBQUMsS0FBSyxHQUFHLEVBQUUsRUFBRSxHQUFHLENBQUMsTUFBTSxDQUFDLE1BQU0sR0FBRyxFQUFFLENBQUMsQ0FBQTtRQUNwRSxHQUFHLENBQUMsUUFBUSxDQUFDLEVBQUUsRUFBRSxFQUFFLEVBQUUsR0FBRyxDQUFDLE1BQU0sQ0FBQyxLQUFLLEdBQUcsRUFBRSxFQUFFLEdBQUcsQ0FBQyxNQUFNLENBQUMsTUFBTSxHQUFHLEVBQUUsQ0FBQyxDQUFBO1FBQ25FLFFBQVEsR0FBRyxFQUFFLENBQUE7UUFDYixJQUFJLENBQUMsTUFBTSxFQUFFLENBQUE7UUFDYixRQUFRLEdBQUcsSUFBSSxDQUFBO0lBQ2pCLENBQUM7Q0FFRixDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBtaW5pcHJvZ3JhbS9wYWdlcy9zaWduYXR1cmUuanNcbmltcG9ydCB7IEJlemllciB9IGZyb20gJy4uLy4uL2xpYi9iZXppZXInXG5pbXBvcnQgeyBCYXNpY1BvaW50LCBQb2ludCB9IGZyb20gJy4uLy4uL2xpYi9wb2ludCdcbmltcG9ydCB7IHRocm90dGxlIH0gZnJvbSAnLi4vLi4vbGliL3Rocm90dGxlJ1xuXG5cbmV4cG9ydCBpbnRlcmZhY2UgUG9pbnRHcm91cCB7XG4gIGNvbG9yOiBzdHJpbmc7XG4gIHBvaW50czogQmFzaWNQb2ludFtdO1xufVxuXG4vLyBjYW52YXMgY29udGV4dFxubGV0IGN0eDogYW55ID0gbnVsbFxuLy8gdG91Y2ggZHJhd2luZ1xubGV0IGlzVG91Y2hpbmc6IGJvb2xlYW4gPSBmYWxzZVxubGV0IF9pc0VtcHR5OiBib29sZWFuID0gZmFsc2VcbmxldCBtaW5EaXN0YW5jZTogbnVtYmVyID0gNVxubGV0IGJhY2tncm91bmRDb2xvciA9ICcjNGY3MzZkJ1xubGV0IHBlbiA9IHsgY29sb3I6ICcjMzMzMzMzJywgd2lkdGg6IDEsIF9tYXhXaWR0aDogMTAgfVxubGV0IGRwciA9IDFcblxubGV0IF9tYXhXaWR0aDogbnVtYmVyID0gMi41XG5sZXQgX21pbldpZHRoOiBudW1iZXIgPSAwLjVcbmxldCBfZG90U2l6ZTogbnVtYmVyID0gKF9taW5XaWR0aCArIF9tYXhXaWR0aCkgLyAyXG5cbmxldCBfbGFzdFBvaW50czogUG9pbnRbXSA9IFtdXG5sZXQgdmVsb2NpdHlGaWx0ZXJXZWlnaHQ6IG51bWJlciA9IDAuN1xubGV0IF9sYXN0VmVsb2NpdHk6IG51bWJlciA9IDBcbmxldCBfbGFzdFdpZHRoOiBudW1iZXIgPSAoX21pbldpZHRoICsgX21heFdpZHRoKSAvIDJcbmxldCBfc3Ryb2tlTW92ZVVwZGF0ZTogYW55ID0gbnVsbFxuXG4vLyDml7bpl7TovbTvvIzorrDlvZXmk43kvZzmraXpqqTmlbDmja5cbmxldCB0aW1lTGluZTogUG9pbnRHcm91cFtdID0gW11cblxuUGFnZSh7XG5cbiAgLyoqXG4gICAqIFBhZ2UgaW5pdGlhbCBkYXRhXG4gICAqL1xuICBkYXRhOiB7XG5cbiAgfSxcblxuICAvKipcbiAgICogTGlmZWN5Y2xlIGZ1bmN0aW9uLS1DYWxsZWQgd2hlbiBwYWdlIGxvYWRcbiAgICovXG4gIG9uTG9hZDogZnVuY3Rpb24gKG9wdGlvbnMpIHtcbiAgICBjb25zb2xlLmxvZygnb25Mb2FkJylcbiAgfSxcblxuICAvKipcbiAgICogTGlmZWN5Y2xlIGZ1bmN0aW9uLS1DYWxsZWQgd2hlbiBwYWdlIGlzIGluaXRpYWxseSByZW5kZXJlZFxuICAgKi9cbiAgb25SZWFkeTogZnVuY3Rpb24gKCkge1xuICAgIHRoaXMuaW5pdENvbnRleHQoKVxuICAgIF9zdHJva2VNb3ZlVXBkYXRlID0gdGhyb3R0bGUodGhpcy5fc3Ryb2tlVXBkYXRlLCAxNilcbiAgfSxcblxuICAvKipcbiAgICogTGlmZWN5Y2xlIGZ1bmN0aW9uLS1DYWxsZWQgd2hlbiBwYWdlIHNob3dcbiAgICovXG4gIG9uU2hvdzogZnVuY3Rpb24gKCkge1xuXG4gIH0sXG5cbiAgLyoqXG4gICAqIExpZmVjeWNsZSBmdW5jdGlvbi0tQ2FsbGVkIHdoZW4gcGFnZSBoaWRlXG4gICAqL1xuICBvbkhpZGU6IGZ1bmN0aW9uICgpIHtcblxuICB9LFxuXG4gIC8qKlxuICAgKiBMaWZlY3ljbGUgZnVuY3Rpb24tLUNhbGxlZCB3aGVuIHBhZ2UgdW5sb2FkXG4gICAqL1xuICBvblVubG9hZDogZnVuY3Rpb24gKCkge1xuXG4gIH0sXG5cbiAgLyoqXG4gICAqIGluaXQgY2FudmFzIGNvbnRleHRcbiAgICovXG4gIGluaXRDb250ZXh0ICgpIHtcbiAgICBjb25zdCB7IHBpeGVsUmF0aW8sIHdpbmRvd1dpZHRoLCB3aW5kb3dIZWlnaHQgfSA9IHd4LmdldFN5c3RlbUluZm9TeW5jKClcbiAgICBkcHIgPSBwaXhlbFJhdGlvXG4gICAgY29uc29sZS5sb2coJ3BpeGVsUmF0aW8nLCBwaXhlbFJhdGlvKVxuXG4gICAgY29uc3QgcXVlcnkgPSB3eC5jcmVhdGVTZWxlY3RvclF1ZXJ5KClcbiAgICBxdWVyeS5zZWxlY3QoJyNjYW52YXMnKS5ub2RlKCkuZXhlYygocmVzKSA9PiB7XG4gICAgICBjb25zdCBjYW52YXMgPSByZXNbMF0ubm9kZVxuICAgICAgY29uc29sZS5sb2coJ2NhbnZhcyAtLS0gJywgY2FudmFzKVxuICAgICAgLy8gY2FudmFzLndpZHRoID0gd2luZG93V2lkdGggKiBkcHJcbiAgICAgIC8vIGNhbnZhcy5oZWlnaHQgPSB3aW5kb3dIZWlnaHQgKiBkcHJcbiAgICAgIGNhbnZhcy53aWR0aCA9IHdpbmRvd1dpZHRoXG4gICAgICBjYW52YXMuaGVpZ2h0ID0gd2luZG93SGVpZ2h0XG5cbiAgICAgIGN0eCA9IGNhbnZhcy5nZXRDb250ZXh0KCcyZCcpXG4gICAgICAvLyBjdHguc2NhbGUocGl4ZWxSYXRpbywgcGl4ZWxSYXRpbylcbiAgICAgIGNvbnNvbGUubG9nKCdjdHgnLCBjdHgpXG5cbiAgICAgIGN0eC5maWxsU3R5bGUgPSBiYWNrZ3JvdW5kQ29sb3JcbiAgICAgIGN0eC5maWxsUmVjdCgxNiwgMTYsIGN0eC5jYW52YXMud2lkdGggLSAzMiwgY3R4LmNhbnZhcy5oZWlnaHQgLSAzMilcbiAgICB9KVxuICB9LFxuXG4gIG9uVG91Y2hTdGFydCAoZXZlbnQ6IGFueSkgOiB2b2lkIHtcbiAgICBjb25zb2xlLmxvZygndG91Y2ggc3RhcnQgLS0gJywgZXZlbnQpXG4gICAgaXNUb3VjaGluZyA9IHRydWVcbiAgICB0aGlzLl9zdHJva2VCZWdpbihldmVudClcbiAgfSxcblxuICBvblRvdWNoTW92ZSAoZXZlbnQ6IGFueSkgOiB2b2lkIHtcbiAgICAvLyBjb25zb2xlLmxvZygndG91Y2ggbW92ZSAtLScsIGV2ZW50KVxuICAgIHRoaXMuX3N0cm9rZVVwZGF0ZShldmVudClcbiAgfSxcblxuICBvblRvdWNoRW5kIChldmVudDogYW55KSA6IHZvaWQge1xuICAgIGNvbnNvbGUubG9nKCd0b3VjaCBlbmQgLS0nLCBldmVudClcbiAgICBpc1RvdWNoaW5nID0gZmFsc2VcbiAgICB0aGlzLl9zdHJva2VFbmQoZXZlbnQpXG4gIH0sXG5cbiAgb25Ub3VjaENhbmNlbCAoZXZlbnQ6IGFueSkgOiB2b2lkIHtcbiAgICBjb25zb2xlLmxvZygndG91Y2ggY2FuY2VsJywgZXZlbnQpXG4gICAgaXNUb3VjaGluZyA9IGZhbHNlXG4gICAgdGhpcy5fc3Ryb2tlRW5kKGV2ZW50KVxuICB9LFxuXG4gIG9uRXJyb3IgKGV2ZW50OiBhbnkpIHtcbiAgICBjb25zb2xlLmxvZygnY2FudmFzIGVycm9yJywgZXZlbnQpXG4gICAgaXNUb3VjaGluZyA9IGZhbHNlXG4gICAgdGhpcy5fc3Ryb2tlRW5kKGV2ZW50KVxuICB9LFxuXG4gIF9zdHJva2VCZWdpbiAoZXZlbnQ/OiBhbnkpIDogdm9pZCB7XG4gICAgY29uc3QgbmV3UG9pbnRHcm91cCA9IHtcbiAgICAgIGNvbG9yOiBwZW4uY29sb3IsXG4gICAgICBwb2ludHM6IFtdLFxuICAgIH07XG4gICAgdGltZUxpbmUucHVzaChuZXdQb2ludEdyb3VwKTtcbiAgICB0aGlzLl9yZXNldCgpO1xuICAgIHRoaXMuX3N0cm9rZVVwZGF0ZShldmVudClcbiAgfSxcblxuICBfc3Ryb2tlVXBkYXRlIChldmVudDogYW55KSA6IHZvaWQge1xuICAgIGlmICh0aW1lTGluZS5sZW5ndGggPT09IDApIHtcbiAgICAgIHRoaXMuX3N0cm9rZUJlZ2luKGV2ZW50KVxuICAgICAgcmV0dXJuXG4gICAgfVxuICAgIGNvbnN0IHt4LCB5fSA9IGV2ZW50LnRvdWNoZXNbMF1cbiAgICBjb25zb2xlLmxvZygndGltZUxpbmUnLCB0aW1lTGluZSlcbiAgICBjb25zdCBwb2ludCA9IHRoaXMuX2NyZWF0ZVBvaW50KHgsIHkpXG4gICAgY29uc3QgbGFzdFBvaW50R3JvdXAgPSB0aW1lTGluZVt0aW1lTGluZS5sZW5ndGggLSAxXVxuICAgIGNvbnN0IGxhc3RQb2ludHMgPSBsYXN0UG9pbnRHcm91cC5wb2ludHNcbiAgICBjb25zdCBsYXN0UG9pbnQgPSBsYXN0UG9pbnRzLmxlbmd0aCA+IDAgJiYgbGFzdFBvaW50c1tsYXN0UG9pbnRzLmxlbmd0aCAtIDFdXG4gICAgY29uc3QgaXNMYXN0UG9pbnRUb29DbG9zZSA9IGxhc3RQb2ludCA/IHBvaW50LmRpc3RhbmNlVG8obGFzdFBvaW50KSA8PSBtaW5EaXN0YW5jZSA6IGZhbHNlXG4gICAgcGVuLmNvbG9yID0gbGFzdFBvaW50R3JvdXAuY29sb3JcbiAgICBjb25zb2xlLmxvZygnbGFzdFBvaW50JywgbGFzdFBvaW50KVxuICAgIGNvbnNvbGUubG9nKCdpc0xhc3RQb2ludFRvb0Nsb3NlJywgaXNMYXN0UG9pbnRUb29DbG9zZSlcbiAgICBpZiAoIWxhc3RQb2ludCB8fCAhKGxhc3RQb2ludCAmJiBpc0xhc3RQb2ludFRvb0Nsb3NlKSkge1xuICAgICAgY29uc3QgY3VydmUgPSB0aGlzLl9hZGRQb2ludChwb2ludClcbiAgICAgIGlmICghY3VydmUpIHtcbiAgICAgICAgdGhpcy5fZHJhd0RvdChwb2ludClcbiAgICAgIH0gZWxzZSBpZiAoY3VydmUpIHtcbiAgICAgICAgdGhpcy5fZHJhd0N1cnZlKGN1cnZlKVxuICAgICAgfVxuICAgIH1cbiAgfSxcblxuICBfc3Ryb2tlRW5kIChldmVudDogYW55KSA6IHZvaWQge1xuICAgIGNvbnNvbGUubG9nKCdlbmQgKysrKysrKyAnLCBldmVudClcbiAgICAvLyB0aGlzLl9zdHJva2VVcGRhdGUoZXZlbnQpXG4gIH0sXG5cbiAgX2NhbGN1bGF0ZUN1cnZlV2lkdGhzIChzdGFydFBvaW50OiBQb2ludCwgZW5kUG9pbnQ6IFBvaW50KSA6IHsgc3RhcnQ6IG51bWJlcjsgZW5kOiBudW1iZXIgfSB7XG4gICAgY29uc3QgdmVsb2NpdHkgPSB2ZWxvY2l0eUZpbHRlcldlaWdodCAqIGVuZFBvaW50LnZlbG9jaXR5RnJvbShzdGFydFBvaW50KSArICgxIC0gdmVsb2NpdHlGaWx0ZXJXZWlnaHQpICogX2xhc3RWZWxvY2l0eVxuICAgIGNvbnN0IG5ld1dpZHRoID0gdGhpcy5fc3Ryb2tlV2lkdGgodmVsb2NpdHkpXG4gICAgY29uc3Qgd2lkdGhzID0ge1xuICAgICAgc3RhcnQ6IF9sYXN0V2lkdGgsXG4gICAgICBlbmQ6IG5ld1dpZHRoLFxuICAgIH1cbiAgICBfbGFzdFZlbG9jaXR5ID0gdmVsb2NpdHlcbiAgICBfbGFzdFdpZHRoID0gbmV3V2lkdGhcbiAgICByZXR1cm4gd2lkdGhzXG4gIH0sXG5cbiAgX3N0cm9rZVdpZHRoICh2ZWxvY2l0eTogbnVtYmVyKSB7XG4gICAgcmV0dXJuIE1hdGgubWF4KF9tYXhXaWR0aCAvICh2ZWxvY2l0eSArIDEpLCBfbWluV2lkdGgpO1xuICB9LFxuXG4gIF9jcmVhdGVQb2ludCh4OiBudW1iZXIsIHk6IG51bWJlcik6IFBvaW50IHtcbiAgICAvLyBjb25zdCB7bGVmdCwgdG9wfSA9IGN0eC5jYW52YXM7XG4gICAgY29uc3QgbGVmdCA9IDA7XG4gICAgY29uc3QgdG9wID0gMDtcbiAgICByZXR1cm4gbmV3IFBvaW50KHggLSBsZWZ0LCB5IC0gdG9wLCBuZXcgRGF0ZSgpLmdldFRpbWUoKSk7XG4gIH0sXG5cbiAgX2FkZFBvaW50KHBvaW50OiBQb2ludCkgOiBCZXppZXIgfCBudWxsIHtcbiAgICBfbGFzdFBvaW50cy5wdXNoKHBvaW50KTtcbiAgICBpZiAoX2xhc3RQb2ludHMubGVuZ3RoID4gMikge1xuICAgICAgLy8gVG8gcmVkdWNlIHRoZSBpbml0aWFsIGxhZyBtYWtlIGl0IHdvcmsgd2l0aCAzIHBvaW50c1xuICAgICAgLy8gYnkgY29weWluZyB0aGUgZmlyc3QgcG9pbnQgdG8gdGhlIGJlZ2lubmluZy5cbiAgICAgIGlmIChfbGFzdFBvaW50cy5sZW5ndGggPT09IDMpIHtcbiAgICAgICAgX2xhc3RQb2ludHMudW5zaGlmdChfbGFzdFBvaW50c1swXSk7XG4gICAgICB9XG5cbiAgICAgIC8vIF9wb2ludHMgYXJyYXkgd2lsbCBhbHdheXMgaGF2ZSA0IHBvaW50cyBoZXJlLlxuICAgICAgY29uc3Qgd2lkdGhzID0gdGhpcy5fY2FsY3VsYXRlQ3VydmVXaWR0aHMoX2xhc3RQb2ludHNbMV0sIF9sYXN0UG9pbnRzWzJdKTtcbiAgICAgIGNvbnN0IGN1cnZlID0gQmV6aWVyLmZyb21Qb2ludHMoX2xhc3RQb2ludHMsIHdpZHRocyk7XG5cbiAgICAgIC8vIFJlbW92ZSB0aGUgZmlyc3QgZWxlbWVudCBmcm9tIHRoZSBsaXN0LCBzbyB0aGF0IHRoZXJlIGFyZSBubyBtb3JlIHRoYW4gNCBwb2ludHMgYXQgYW55IHRpbWUuXG4gICAgICBfbGFzdFBvaW50cy5zaGlmdCgpO1xuXG4gICAgICByZXR1cm4gY3VydmU7XG4gICAgfVxuXG4gICAgcmV0dXJuIG51bGw7XG4gIH0sXG5cbiAgX2RyYXdEb3QgKHBvaW50OiBCYXNpY1BvaW50KSA6IHZvaWQge1xuICAgIGN0eC5iZWdpblBhdGgoKTtcbiAgICBjb25zdCB3aWR0aCA9IF9kb3RTaXplXG4gICAgdGhpcy5fZHJhd0N1cnZlU2VnbWVudChwb2ludC54LCBwb2ludC55LCB3aWR0aCk7XG4gICAgY3R4LmNsb3NlUGF0aCgpO1xuICAgIGN0eC5maWxsU3R5bGUgPSBwZW4uY29sb3I7XG4gICAgY3R4LmZpbGwoKTtcbiAgfSxcblxuICBfZHJhd0N1cnZlU2VnbWVudCAoeDogbnVtYmVyLCB5Om51bWJlciwgd2lkdGg6IG51bWJlcikge1xuICAgIGN0eC5tb3ZlVG8oeCwgeSlcbiAgICBjdHguYXJjKHgsIHksIHdpZHRoLCAwLCAyICogTWF0aC5QSSwgZmFsc2UpXG4gICAgX2lzRW1wdHkgPSBmYWxzZVxuICB9LFxuXG4gIF9kcmF3Q3VydmUoY3VydmU6IEJlemllcik6IHZvaWQge1xuICAgIGNvbnNvbGUubG9nKCdfZHJhd0N1cnZlIC0tLS0gJywgY3VydmUpXG4gICAgY29uc3Qgd2lkdGhEZWx0YSA9IGN1cnZlLmVuZFdpZHRoIC0gY3VydmUuc3RhcnRXaWR0aFxuICAgIC8vICcyJyBpcyBqdXN0IGFuIGFyYml0cmFyeSBudW1iZXIgaGVyZS4gSWYgb25seSBsZW5naHQgaXMgdXNlZCwgdGhlblxuICAgIC8vIHRoZXJlIGFyZSBnYXBzIGJldHdlZW4gY3VydmUgc2VnbWVudHMgOi9cbiAgICBjb25zdCBkcmF3U3RlcHMgPSBNYXRoLmZsb29yKGN1cnZlLmxlbmd0aCgpKSAqIDJcblxuICAgIGN0eC5iZWdpblBhdGgoKVxuICAgIGN0eC5maWxsU3R5bGUgPSBwZW4uY29sb3JcblxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZHJhd1N0ZXBzOyBpICs9IDEpIHtcbiAgICAgIC8vIENhbGN1bGF0ZSB0aGUgQmV6aWVyICh4LCB5KSBjb29yZGluYXRlIGZvciB0aGlzIHN0ZXAuXG4gICAgICBjb25zdCB0ID0gaSAvIGRyYXdTdGVwc1xuICAgICAgY29uc3QgdHQgPSB0ICogdFxuICAgICAgY29uc3QgdHR0ID0gdHQgKiB0XG4gICAgICBjb25zdCB1ID0gMSAtIHRcbiAgICAgIGNvbnN0IHV1ID0gdSAqIHVcbiAgICAgIGNvbnN0IHV1dSA9IHV1ICogdVxuXG4gICAgICBsZXQgeCA9IHV1dSAqIGN1cnZlLnN0YXJ0UG9pbnQueFxuICAgICAgeCArPSAzICogdXUgKiB0ICogY3VydmUuY29udHJvbDEueFxuICAgICAgeCArPSAzICogdSAqIHR0ICogY3VydmUuY29udHJvbDIueFxuICAgICAgeCArPSB0dHQgKiBjdXJ2ZS5lbmRQb2ludC54XG5cbiAgICAgIGxldCB5ID0gdXV1ICogY3VydmUuc3RhcnRQb2ludC55XG4gICAgICB5ICs9IDMgKiB1dSAqIHQgKiBjdXJ2ZS5jb250cm9sMS55XG4gICAgICB5ICs9IDMgKiB1ICogdHQgKiBjdXJ2ZS5jb250cm9sMi55XG4gICAgICB5ICs9IHR0dCAqIGN1cnZlLmVuZFBvaW50LnlcblxuICAgICAgY29uc3Qgd2lkdGggPSBNYXRoLm1pbihcbiAgICAgICAgY3VydmUuc3RhcnRXaWR0aCArIHR0dCAqIHdpZHRoRGVsdGEsXG4gICAgICAgIHBlbi5fbWF4V2lkdGgsXG4gICAgICApO1xuICAgICAgdGhpcy5fZHJhd0N1cnZlU2VnbWVudCh4LCB5LCB3aWR0aCk7XG4gICAgfVxuXG4gICAgY3R4LmNsb3NlUGF0aCgpO1xuICAgIGN0eC5maWxsKCk7XG4gIH0sXG5cbiAgX2xpbmVUbyAoeDogbnVtYmVyLCB5OiBudW1iZXIpIDogdm9pZCB7XG4gICAgY3R4LmxpbmVUbyh4ICogZHByLCB5ICogZHByKVxuICB9LFxuXG4gIF9tb3ZlVG8gKHg6IG51bWJlciwgeTogbnVtYmVyKSA6IHZvaWQge1xuICAgIGN0eC5tb3ZlVG8oeCAqIGRwciwgeSAqIGRwcilcbiAgfSxcblxuICBfcmVzZXQgKCkgOiB2b2lkIHtcbiAgICBfbGFzdFBvaW50cyA9IFtdXG4gICAgX2xhc3RWZWxvY2l0eSA9IDBcbiAgICBfbGFzdFdpZHRoID0gKF9taW5XaWR0aCArIF9tYXhXaWR0aCkgLyAyXG4gICAgY3R4LmZpbGxTdHlsZSA9IHBlbi5jb2xvclxuICB9LFxuXG4gIF9jbGVhciAoKSA6IHZvaWQge1xuICAgIGN0eC5maWxsU3R5bGUgPSBiYWNrZ3JvdW5kQ29sb3I7XG4gICAgY3R4LmNsZWFyUmVjdCgxNiwgMTYsIGN0eC5jYW52YXMud2lkdGggLSAzMiwgY3R4LmNhbnZhcy5oZWlnaHQgLSAzMilcbiAgICBjdHguZmlsbFJlY3QoMTYsIDE2LCBjdHguY2FudmFzLndpZHRoIC0gMzIsIGN0eC5jYW52YXMuaGVpZ2h0IC0gMzIpXG4gICAgdGltZUxpbmUgPSBbXVxuICAgIHRoaXMuX3Jlc2V0KClcbiAgICBfaXNFbXB0eSA9IHRydWVcbiAgfSxcblxufSkiXX0=